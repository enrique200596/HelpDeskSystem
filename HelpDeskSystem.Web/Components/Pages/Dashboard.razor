@page "/dashboard"
@attribute [Authorize]
@using HelpDeskSystem.Domain.Entities
@using HelpDeskSystem.Domain.Enums
@using HelpDeskSystem.Web.Services
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@using System.Globalization
@inject TicketStateContainer StateContainer
@inject IDashboardService ServicioDashboard
@inject ITicketService ServicioTickets
@inject AuthenticationStateProvider AuthStateProvider
@implements IDisposable

<PageTitle>Dashboard | HelpDesk UTEPSA</PageTitle>

<div class="container-fluid px-4 pb-5">

    @* --- ENCABEZADO --- *@
    <div class="d-flex justify-content-between align-items-end my-4 animate-enter">
        <div>
            <h6 class="text-uppercase text-muted fw-bold ls-1 mb-1">Vista General</h6>
            <h2 class="fw-bold text-dark mb-0">Rendimiento del Sistema</h2>
        </div>
        <div class="d-none d-md-flex gap-2">
            <span class="badge bg-light text-secondary border p-2 px-3 fw-normal">
                <i class="bi bi-calendar-event me-2"></i>@DateTime.Now.ToString("dd MMMM, yyyy")
            </span>
        </div>
    </div>

    @if (metricas == null || ultimosTickets == null)
    {
        @* Skeleton de Carga *@
        <div class="row g-4">
            @for (int i = 0; i < 4; i++)
            {
                <div class="col-md-3"><div class="card-pro p-4 placeholder-glow"><span class="placeholder col-6"></span></div></div>
            }
        </div>
    }
    else
    {
        @* --- FILA 1: KPIs PRINCIPALES --- *@
        <div class="row g-4 mb-4 animate-enter">
            @* KPI 1: Total *@
            <div class="col-md-6 col-xl-3">
                <div class="card-pro h-100 border-start border-4 border-primary">
                    <div class="card-body d-flex align-items-center justify-content-between">
                        <div>
                            <span class="text-uppercase text-muted small fw-bold ls-1">Total Tickets</span>
                            <h2 class="display-6 fw-bold text-dark mt-2 mb-0">@metricas.TotalTickets</h2>
                        </div>
                        <div class="p-3 bg-primary bg-opacity-10 rounded-circle text-primary">
                            <i class="bi bi-ticket-perforated-fill fs-3"></i>
                        </div>
                    </div>
                </div>
            </div>

            @* KPI 2: Pendientes *@
            <div class="col-md-6 col-xl-3">
                <div class="card-pro h-100 border-start border-4 border-warning">
                    <div class="card-body d-flex align-items-center justify-content-between">
                        <div>
                            <span class="text-uppercase text-muted small fw-bold ls-1">Pendientes</span>
                            <h2 class="display-6 fw-bold text-dark mt-2 mb-0">@metricas.Pendientes</h2>
                            <small class="text-muted" style="font-size:0.75rem">Requieren atención</small>
                        </div>
                        <div class="p-3 bg-warning bg-opacity-10 rounded-circle text-warning">
                            <i class="bi bi-hourglass-split fs-3"></i>
                        </div>
                    </div>
                </div>
            </div>

            @* KPI 3: Resueltos *@
            <div class="col-md-6 col-xl-3">
                <div class="card-pro h-100 border-start border-4 border-success">
                    <div class="card-body d-flex align-items-center justify-content-between">
                        <div>
                            <span class="text-uppercase text-muted small fw-bold ls-1">Resueltos</span>
                            <h2 class="display-6 fw-bold text-dark mt-2 mb-0">@metricas.Resueltos</h2>
                            <small class="text-success fw-bold" style="font-size:0.75rem">
                                <i class="bi bi-graph-up-arrow me-1"></i>Efectividad
                            </small>
                        </div>
                        <div class="p-3 bg-success bg-opacity-10 rounded-circle text-success">
                            <i class="bi bi-check-circle-fill fs-3"></i>
                        </div>
                    </div>
                </div>
            </div>

            @* KPI 4: Satisfacción *@
            <div class="col-md-6 col-xl-3">
                <div class="card-pro h-100 border-start border-4 border-info">
                    <div class="card-body d-flex align-items-center justify-content-between">
                        <div>
                            <span class="text-uppercase text-muted small fw-bold ls-1">Calidad</span>
                            @* --- FIX 1: Formato seguro para decimales --- *@
                            <h2 class="display-6 fw-bold text-dark mt-2 mb-0">@metricas.PromedioSatisfaccion.ToString("0.0", CultureInfo.InvariantCulture)</h2>
                            <small class="text-muted" style="font-size:0.75rem">Promedio estrellas</small>
                        </div>
                        <div class="p-3 bg-info bg-opacity-10 rounded-circle text-info">
                            <i class="bi bi-star-fill fs-3"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        @* --- FILA 2: GRÁFICOS Y DETALLES --- *@
        <div class="row g-4 mb-4 animate-enter" style="animation-delay: 0.1s;">

            @* COLUMNA IZQ: Métricas Visuales *@
            <div class="col-lg-4">
                <div class="card-pro h-100">
                    <div class="card-pro-header d-flex justify-content-between align-items-center">
                        <h6 class="fw-bold mb-0">Distribución de Estado</h6>
                        <button class="btn btn-sm btn-light border"><i class="bi bi-three-dots"></i></button>
                    </div>
                    <div class="card-pro-body text-center pt-4">

                        @* GRÁFICO DE DONA CSS PURO (CORREGIDO) *@
                        <div class="position-relative mx-auto mb-4" style="width: 160px; height: 160px;">
                            @* --- FIX 2: USO DE CultureInfo.InvariantCulture PARA EVITAR COMAS EN CSS --- *@
                            <div class="rounded-circle w-100 h-100 shadow-inner"
                                 style="background: conic-gradient(
                                                 var(--utepsa-red) 0% @(PorcentajePendientes.ToString("0.0", CultureInfo.InvariantCulture))%,
                                                 #198754 @(PorcentajePendientes.ToString("0.0", CultureInfo.InvariantCulture))% @((PorcentajePendientes + PorcentajeResueltos).ToString("0.0", CultureInfo.InvariantCulture))%,
                                                 #ffc107 @((PorcentajePendientes + PorcentajeResueltos).ToString("0.0", CultureInfo.InvariantCulture))% 100%
                                             );">
                            </div>
                            @* Agujero de la dona *@
                            <div class="position-absolute top-50 start-50 translate-middle bg-white rounded-circle d-flex flex-column align-items-center justify-content-center"
                                 style="width: 120px; height: 120px;">
                                <span class="display-6 fw-bold text-dark">@metricas.TotalTickets</span>
                                <span class="small text-muted text-uppercase fw-bold" style="font-size: 0.65rem;">Tickets</span>
                            </div>
                        </div>

                        @* Leyenda *@
                        <div class="d-flex justify-content-center gap-4 text-start mt-3">
                            <div>
                                <div class="d-flex align-items-center gap-2 mb-1">
                                    <span class="d-inline-block rounded-circle" style="width: 10px; height: 10px; background-color: var(--utepsa-red);"></span>
                                    <span class="small text-muted">Pendientes</span>
                                </div>
                                <h6 class="fw-bold mb-0">@PorcentajePendientes.ToString("0")%</h6>
                            </div>
                            <div>
                                <div class="d-flex align-items-center gap-2 mb-1">
                                    <span class="d-inline-block rounded-circle" style="width: 10px; height: 10px; background-color: #198754;"></span>
                                    <span class="small text-muted">Resueltos</span>
                                </div>
                                <h6 class="fw-bold mb-0">@PorcentajeResueltos.ToString("0")%</h6>
                            </div>
                        </div>

                        <hr class="my-4 opacity-10" />

                        @* Barras de Progreso *@
                        <div class="text-start px-2">
                            <div class="d-flex justify-content-between mb-1">
                                <small class="fw-bold text-muted">Meta de Resolución Mensual</small>
                                <small class="fw-bold text-primary">85%</small>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-primary" role="progressbar" style="width: 85%" aria-valuenow="85" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            @* COLUMNA DER: Actividad Reciente *@
            <div class="col-lg-8">
                <div class="card-pro h-100">
                    <div class="card-pro-header border-bottom">
                        <h6 class="fw-bold mb-0">Actividad Reciente</h6>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light text-secondary small text-uppercase">
                                <tr>
                                    <th class="ps-4 border-0">Ticket</th>
                                    <th class="border-0">Solicitante</th>
                                    <th class="border-0">Estado</th>
                                    <th class="text-end pe-4 border-0">Acción</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var ticket in ultimosTickets)
                                {
                                    <tr>
                                        <td class="ps-4">
                                            <div class="d-flex flex-column">
                                                <span class="fw-bold text-dark">@ticket.Titulo</span>
                                                <small class="text-muted">#@ticket.Id • @ticket.Categoria?.Nombre</small>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center gap-2">
                                                <div class="rounded-circle bg-light border text-secondary d-flex align-items-center justify-content-center small fw-bold"
                                                     style="width: 28px; height: 28px;">
                                                    @* --- FIX 3: PROTECCIÓN CONTRA NOMBRE VACÍO O NULO --- *@
                                                    @(!string.IsNullOrEmpty(ticket.Usuario?.Nombre) ? ticket.Usuario.Nombre.Substring(0, 1) : "U")
                                                </div>
                                                <small>@ticket.Usuario?.Nombre</small>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge rounded-pill border fw-normal
                                                                        @(ticket.Estado == EstadoTicket.Resuelto ? "bg-success bg-opacity-10 text-success border-success" : ticket.EsUrgente ? "bg-danger bg-opacity-10 text-danger border-danger" : "bg-light text-dark")">
                                                @ticket.Estado
                                            </span>
                                        </td>
                                        <td class="text-end pe-4">
                                            <a href="ticket/@ticket.Id" class="btn btn-sm btn-white border shadow-sm text-muted hover-red">
                                                <i class="bi bi-chevron-right"></i>
                                            </a>
                                        </td>
                                    </tr>
                                }
                                @if (!ultimosTickets.Any())
                                {
                                    <tr>
                                        <td colspan="4" class="text-center py-4 text-muted">Sin actividad reciente</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                    <div class="card-footer bg-white border-0 text-center py-3">
                        <a href="/" class="text-decoration-none small fw-bold text-utepsa-red">Ver todos los tickets</a>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private DashboardDto? metricas;
    private List<Ticket>? ultimosTickets;

    private string rolActual = "";
    private string nombreUsuario = "";
    private Guid usuarioId = Guid.Empty;

    // Variables para el gráfico
    private double PorcentajeResueltos = 0;
    private double PorcentajePendientes = 0;

    protected override async Task OnInitializedAsync()
    {
        StateContainer.OnChange += ActualizarTablero;
        await CargarDatos();
    }

    private async Task CargarDatos()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity != null && user.Identity.IsAuthenticated)
        {
            nombreUsuario = user.Identity.Name ?? "";
            rolActual = user.FindFirst(ClaimTypes.Role)?.Value ?? "Usuario";
            var idClaim = user.FindFirst(ClaimTypes.Sid) ?? user.FindFirst(ClaimTypes.NameIdentifier);
            if (idClaim != null && Guid.TryParse(idClaim.Value, out var parsedId)) usuarioId = parsedId;

            // 1. Cargar Métricas
            metricas = await ServicioDashboard.ObtenerMetricasAsync(usuarioId, rolActual);

            // 2. Cargar Tickets Recientes
            var todosLosTickets = await ServicioTickets.ObtenerTicketsFiltradosAsync(usuarioId, rolActual);
            ultimosTickets = todosLosTickets.OrderByDescending(t => t.FechaCreacion).Take(5).ToList();

            // 3. Calcular Porcentajes para Gráfico
            if (metricas != null && metricas.TotalTickets > 0)
            {
                PorcentajeResueltos = ((double)metricas.Resueltos / metricas.TotalTickets) * 100;
                // Pendientes agrupamos Abiertos + Asignados
                PorcentajePendientes = ((double)metricas.Pendientes / metricas.TotalTickets) * 100;
            }
        }
    }

    private async void ActualizarTablero(int? id, string? t, string? r, Guid? o, Guid? a)
    {
        try // <--- BLINDAJE
        {
            await CargarDatos();
            await InvokeAsync(StateHasChanged);
        }
        catch { /* Ignorar error de navegación */ }
    }

    public void Dispose()
    {
        StateContainer.OnChange -= ActualizarTablero;
    }
}