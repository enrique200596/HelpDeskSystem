@page "/ticket/{Id:int}"
@attribute [Authorize]
@using HelpDeskSystem.Domain.Entities
@using HelpDeskSystem.Domain.Enums
@using HelpDeskSystem.Web.Services
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using System.Threading
@inject ITicketService ServicioTickets
@inject IUsuarioService ServicioUsuarios
@inject IChatService ServicioChat
@inject NavigationManager Navegacion
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JS
@inject TicketStateContainer StateContainer
@implements IDisposable

<PageTitle>Ticket #@Id | HelpDesk</PageTitle>

<style>
    /* --- PALETA INSTITUCIONAL --- */
    :root {
        --utepsa-red: #C8102E;
        --utepsa-dark: #111111;
        --chat-me-bg: #C8102E;
        --chat-other-bg: #ffffff;
    }

    .bg-utepsa-red {
        background-color: var(--utepsa-red) !important;
        color: white;
    }

    .text-utepsa-red {
        color: var(--utepsa-red) !important;
    }

    /* Botón Principal Personalizado */
    .btn-utepsa {
        background-color: var(--utepsa-red);
        color: white;
        border: none;
        font-weight: 600;
        transition: all 0.2s;
    }

        .btn-utepsa:hover {
            background-color: #a30d25;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

    /* Fondo del Chat */
    .bg-chat {
        background-color: #f2f4f8;
        background-image: radial-gradient(#dfe3e8 1px, transparent 1px);
        background-size: 20px 20px;
    }

    /* Burbujas de Chat */
    .bubble {
        padding: 12px 16px;
        border-radius: 12px;
        position: relative;
        font-size: 0.95rem;
        line-height: 1.5;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    .bubble-me {
        background-color: var(--utepsa-red); /* ROJO INSTITUCIONAL */
        color: white;
        border-bottom-right-radius: 2px;
    }

    .bubble-other {
        background-color: white;
        color: #333;
        border-bottom-left-radius: 2px;
        border: 1px solid #e0e0e0;
    }

    /* Enlaces y Modales */
    .hover-link:hover {
        text-decoration: underline !important;
        color: var(--utepsa-red) !important;
    }

    .modal-backdrop-custom {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.9);
        z-index: 2000;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .modal-image-content {
        max-width: 90%;
        max-height: 90vh;
        border-radius: 8px;
    }

    .btn-close-modal {
        position: absolute;
        top: 20px;
        right: 20px;
        color: white;
        background: none;
        border: none;
        font-size: 2rem;
    }

    /* Input Moderno */
    .input-modern-container {
        background: white;
        border-radius: 30px;
        border: 1px solid #dee2e6;
        box-shadow: 0 2px 5px rgba(0,0,0,0.02);
    }
</style>

<div class="container-fluid py-4 px-md-5 bg-light min-vh-100">

    @* --- BOTÓN VOLVER --- *@
    <div class="mb-3">
        <a href="/" class="text-decoration-none text-muted fw-bold small hover-link">
            <i class="bi bi-arrow-left me-1"></i> Volver al Tablero
        </a>
    </div>

    @if (miTicket == null)
    {
        <div class="d-flex justify-content-center align-items-center" style="height: 50vh;">
            <div class="spinner-border text-utepsa-red" role="status"></div>
        </div>
    }
    else
    {
        <div class="row g-4">

            @* COLUMNA IZQUIERDA: INFORMACIÓN Y CONTEXTO *@
            <div class="col-lg-4 order-lg-2">

                @* 1. TARJETA DE ESTADO *@
                <div class="card shadow-sm border-0 mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="badge bg-light text-dark border">#@miTicket.Id</span>
                            <span class="badge @ObtenerClaseBadge(miTicket.Estado)">@miTicket.Estado</span>
                        </div>

                        <h5 class="fw-bold text-dark mb-1">@miTicket.Titulo</h5>
                        <div class="text-muted small mb-3">
                            <i class="bi bi-calendar3 me-1"></i> @miTicket.FechaCreacion.ToString("f")
                        </div>

                        @if (miTicket.EsUrgente)
                        {
                            <div class="alert alert-danger d-flex align-items-center p-2 mb-3 small border-danger">
                                <i class="bi bi-fire me-2 fs-5"></i>
                                <div><strong>PRIORIDAD ALTA</strong><br />Atención inmediata requerida.</div>
                            </div>
                        }

                        <hr class="text-muted opacity-25" />

                        @* ZONA DE ACCIONES *@
                        <div class="d-grid gap-2">
                            @if (rolUsuarioActual == "Administrador")
                            {
                                @if (miTicket.Estado != EstadoTicket.Resuelto)
                                {
                                    <div class="input-group">
                                        <select class="form-select border-secondary" @bind="idAsesorSeleccionado">
                                            <option value="@Guid.Empty">-- Asignar a... --</option>
                                            @foreach (var asesor in listaAsesores)
                                            {
                                                <option value="@asesor.Id">@asesor.Nombre</option>
                                            }
                                        </select>
                                        <button class="btn btn-dark" @onclick="AsignarAsesor">Guardar</button>
                                    </div>
                                }
                                else
                                {
                                    <div class="alert alert-success text-center mb-0 py-2 fw-bold"><i class="bi bi-check-circle-fill"></i> Caso Cerrado</div>
                                }
                            }
                            else if (rolUsuarioActual == "Asesor" && miTicket.AsesorId == null && miTicket.Estado != EstadoTicket.Resuelto)
                            {
                                @* Usamos btn-utepsa (rojo) para la acción principal *@
                                <button class="btn btn-utepsa py-2 shadow-sm" @onclick="AutoAsignar">
                                    <i class="bi bi-hand-index-thumb-fill me-2"></i> Tomar este Caso
                                </button>
                            }
                            else if (miTicket.AsesorId == usuarioActualId && miTicket.Estado != EstadoTicket.Resuelto)
                            {
                                <button class="btn btn-success fw-bold py-2 shadow-sm" @onclick="MarcarComoResuelto">
                                    <i class="bi bi-check2-circle me-2"></i> Finalizar Caso
                                </button>
                            }
                        </div>
                    </div>
                </div>

                @* 2. DETALLES (Estilo UTEPSA) *@
                <div class="card shadow-sm border-0 mb-3">
                    <div class="card-body">
                        <h6 class="fw-bold text-muted text-uppercase small ls-1 mb-3">Detalles</h6>

                        <div class="d-flex align-items-center mb-3">
                            <div class="bg-dark text-white rounded-circle p-2 me-3" style="width: 40px; height: 40px; display:grid; place-items:center;">
                                <i class="bi bi-person-fill fs-5"></i>
                            </div>
                            <div>
                                <small class="text-muted d-block">Solicitante</small>
                                <span class="fw-bold text-dark">@(miTicket.Usuario?.Nombre ?? "Anónimo")</span>
                            </div>
                        </div>

                        <div class="d-flex align-items-center mb-3">
                            <div class="bg-light text-dark border rounded-circle p-2 me-3" style="width: 40px; height: 40px; display:grid; place-items:center;">
                                <i class="bi bi-tag-fill fs-5 text-secondary"></i>
                            </div>
                            <div>
                                <small class="text-muted d-block">Categoría</small>
                                <span class="fw-bold text-dark">@(miTicket.Categoria?.Nombre ?? "General")</span>
                            </div>
                        </div>

                        @if (miTicket.Asesor != null)
                        {
                            <div class="d-flex align-items-center">
                                @* Icono rojo para el asesor *@
                                <div class="bg-utepsa-red rounded-circle p-2 me-3" style="width: 40px; height: 40px; display:grid; place-items:center;">
                                    <i class="bi bi-headset fs-5 text-white"></i>
                                </div>
                                <div>
                                    <small class="text-muted d-block">Atendido por</small>
                                    <span class="fw-bold text-dark">@miTicket.Asesor.Nombre</span>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                @* 3. DESCRIPCIÓN COLAPSABLE *@
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-white py-3 cursor-pointer" data-bs-toggle="collapse" data-bs-target="#collapseDesc">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 fw-bold text-secondary"><i class="bi bi-file-text me-2"></i>Descripción Original</h6>
                            <i class="bi bi-chevron-down text-muted"></i>
                        </div>
                    </div>
                    <div id="collapseDesc" class="collapse show">
                        <div class="card-body bg-light border-top">
                            @if (modoEdicion)
                            {
                                <EditForm Model="miTicket" OnValidSubmit="GuardarCambios">
                                    <DataAnnotationsValidator />
                                    <InputText @bind-Value="miTicket.Titulo" class="form-control mb-2 fw-bold" />
                                    <InputTextArea @bind-Value="miTicket.Descripcion" class="form-control mb-2" rows="5" />
                                    <div class="d-flex gap-2 justify-content-end">
                                        <button type="button" class="btn btn-sm btn-secondary" @onclick="CancelarEdicion">Cancelar</button>
                                        <button type="submit" class="btn btn-sm btn-success">Guardar</button>
                                    </div>
                                </EditForm>
                            }
                            else
                            {
                                <p class="mb-0 text-break text-dark" style="white-space: pre-wrap;">@miTicket.Descripcion</p>

                                @if (!miTicket.FueEditado && miTicket.UsuarioId == usuarioActualId && miTicket.Estado == EstadoTicket.Abierto)
                                {
                                    <div class="text-end mt-2">
                                        <button class="btn btn-link btn-sm p-0 text-muted" @onclick="() => modoEdicion = true">
                                            <i class="bi bi-pencil-square"></i> Editar
                                        </button>
                                    </div>
                                }
                            }
                        </div>
                    </div>
                </div>

            </div>

            @* COLUMNA CENTRAL: CHAT *@
            <div class="col-lg-8 order-lg-1">
                <div class="card shadow-sm border-0 h-100 d-flex flex-column">

                    @* HEADER CHAT *@
                    <div class="card-header bg-white py-3 border-bottom">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-chat-square-text-fill text-utepsa-red me-2 fs-5"></i>
                            <h5 class="mb-0 fw-bold">Comunicación en Vivo</h5>
                        </div>
                    </div>

                    @* BODY CHAT *@
                    <div id="chatBox" class="card-body bg-chat p-4 d-flex flex-column" style="height: 600px; overflow-y: auto;">
                        @if (mensajes.Count == 0)
                        {
                            <div class="text-center my-auto opacity-50">
                                <i class="bi bi-chat-dots fs-1"></i>
                                <p class="mt-2">El espacio de comunicación está abierto.</p>
                            </div>
                        }
                        else
                        {
                            @foreach (var msg in mensajes)
                            {
                                bool soyYo = msg.UsuarioId == usuarioActualId;
                                <div class="d-flex w-100 mb-3 @(soyYo ? "justify-content-end" : "justify-content-start")">
                                    <div style="max-width: 75%;">
                                        <div class="d-flex align-items-end gap-2 @(soyYo ? "flex-row-reverse" : "")">

                                            @* AVATAR: Rojo para mí, Gris para otros *@
                                            <div class="avatar-sm rounded-circle d-flex align-items-center justify-content-center text-white small fw-bold shadow-sm flex-shrink-0"
                                                 style="width: 32px; height: 32px; background-color: @(soyYo ? "var(--utepsa-red)" : "#6c757d");">
                                                @(msg.Usuario?.Nombre?.Substring(0, 1) ?? "?")
                                            </div>

                                            @* BURBUJA: Usa las clases bubble-me (roja) o bubble-other (blanca) *@
                                            <div class="bubble @(soyYo ? "bubble-me" : "bubble-other")">
                                                @if (!soyYo)
                                                {
                                                    <div class="fw-bold small mb-1 @(soyYo ? "text-white-50" : "text-utepsa-red")">@msg.Usuario?.Nombre</div>
                                                }

                                                <div class="text-break">@msg.Contenido</div>

                                                @* CORRECCIÓN: Solo renderizar si existe una URL válida *@
                                                @if (!string.IsNullOrWhiteSpace(msg.AdjuntoUrl))
                                                {
                                                    <div class="mt-2">
                                                        <a href="@msg.AdjuntoUrl" target="_blank" class="btn btn-sm btn-light border w-100 text-truncate text-dark shadow-sm">
                                                            <i class="bi bi-paperclip me-1"></i> Ver Adjunto
                                                        </a>
                                                    </div>
                                                }

                                                <div class="text-end mt-1 opacity-50" style="font-size: 0.65rem;">
                                                    @msg.FechaHora.ToString("HH:mm") @(soyYo ? "✓" : "")
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                    </div>

                    @* FOOTER CHAT (INPUT) *@
                    <div class="card-footer bg-white p-3 border-top">
                        @if (miTicket.Estado == EstadoTicket.Resuelto)
                        {
                            <div class="alert alert-secondary text-center mb-0 border-0 bg-light text-muted">
                                <i class="bi bi-lock-fill me-2"></i> La conversación ha finalizado.
                            </div>

                            @if (miTicket.UsuarioId == usuarioActualId && miTicket.SatisfaccionUsuario == null)
                            {
                                <div class="text-center mt-3 animate-fade-in">
                                    <h6 class="fw-bold text-dark">¿Cómo calificarías la atención?</h6>
                                    <div class="d-flex justify-content-center gap-2 mt-2">
                                        @* CORRECCIÓN: Se añade variable 'estaCalificando' para evitar clics múltiples *@
                                        @for (int i = 1; i <= 5; i++)
                                        {
                                            int r = i;
                                            <button class="btn btn-outline-warning rounded-circle shadow-sm"
                                                    style="width: 45px; height: 45px;"
                                                    @onclick="() => Calificar(r)"
                                                    disabled="@estaCalificando">
                                                <i class="bi bi-star-fill"></i>
                                            </button>
                                        }
                                    </div>
                                </div>
                            }
                        }
                        else if (miTicket.AsesorId == null && rolUsuarioActual == "Usuario")
                        {
                            <div class="alert alert-warning text-center mb-0 border-0 shadow-sm">
                                <div class="d-flex align-items-center justify-content-center gap-2">
                                    <div class="spinner-grow spinner-grow-sm text-warning" role="status"></div>
                                    <span>Esperando a un asesor disponible...</span>
                                </div>
                            </div>
                        }
                        else
                        {
                            <EditForm Model="nuevoMensaje" OnValidSubmit="EnviarMensaje">
                                @* Contenedor Flex centrado *@
                                <div class="input-modern-container d-flex align-items-center p-1">

                                    @* BOTÓN CLIP: Centrado absoluto con grid place-items *@
                                    <label class="btn btn-light rounded-circle border-0 text-secondary m-1 flex-shrink-0"
                                           style="width: 40px; height: 40px; display: grid; place-items: center; cursor: pointer;"
                                           title="Adjuntar Archivo">
                                        <i class="bi bi-paperclip fs-5 d-flex"></i> @* d-flex en el i elimina espacio fantasma *@
                                        <InputFile OnChange="ManejarSeleccionArchivo" style="display: none;" />
                                    </label>

                                    <div class="flex-grow-1 px-2 position-relative d-flex align-items-center">
                                        @if (archivoSeleccionado != null) { /* ... */ }

                                        @* Input Text alineado *@
                                        <InputText id="txtMensaje" @bind-Value="nuevoMensaje.Contenido"
                                                   class="form-control border-0 shadow-none bg-transparent py-2"
                                                   placeholder="Escribe tu mensaje aquí..." autocomplete="off" />
                                    </div>

                                    @* BOTÓN ENVIAR: Centrado igual que el clip *@
                                    <button class="btn btn-utepsa rounded-circle shadow-sm m-1 flex-shrink-0"
                                            style="width: 42px; height: 42px; display: grid; place-items: center;"
                                            type="submit" disabled="@enviandoMensaje">
                                        @if (enviandoMensaje)
                                        {
                                            <span class="spinner-border spinner-border-sm"></span>
                                        }
                                        else
                                        {
                                            <i class="bi bi-send-fill d-flex ps-1"></i> @* ps-1 para compensar visualmente el ícono de 'avión' *@
                                        }
                                    </button>
                                </div>
                            </EditForm>
                        }
                    </div>
                </div>
            </div>
        </div>
    }

    @* MODAL IMAGEN *@
    @if (!string.IsNullOrEmpty(imagenModalUrl))
    {
        <div class="modal-backdrop-custom" @onclick="CerrarModal">
            <button class="btn-close-modal">&times;</button>
            <img src="@imagenModalUrl" class="modal-image-content" @onclick:stopPropagation="true" />
        </div>
    }
</div>

@code {
    [Parameter] public int Id { get; set; }

    // --- ESTADO Y MODELOS ---
    private Ticket? miTicket;
    private List<Usuario> listaAsesores = new();
    private Guid idAsesorSeleccionado;
    private bool modoEdicion = false;
    private bool enviandoMensaje = false;

    // --- CHAT ---
    private List<Mensaje> mensajes = new();
    private Mensaje nuevoMensaje = new Mensaje();
    private IBrowserFile? archivoSeleccionado;
    private string? imagenModalUrl = null;

    // --- USUARIO ACTUAL ---
    private Guid usuarioActualId = Guid.Empty;
    private string rolUsuarioActual = "";

    private bool estaCalificando = false;

    protected override async Task OnInitializedAsync()
    {
        StateContainer.OnChange += ActualizarChatEnVivo;

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user?.Identity?.IsAuthenticated == true)
        {
            var idClaim = user.FindFirst(ClaimTypes.Sid) ?? user.FindFirst(ClaimTypes.NameIdentifier);
            if (Guid.TryParse(idClaim?.Value, out var parsed)) usuarioActualId = parsed;
            rolUsuarioActual = user.FindFirst(ClaimTypes.Role)?.Value ?? "";
        }

        await CargarDatosCompletos();

        if (rolUsuarioActual == "Administrador") listaAsesores = await ServicioUsuarios.ObtenerAsesoresAsync();

        await ScrollAlFondo();
    }

    private async Task CargarDatosCompletos()
    {
        miTicket = await ServicioTickets.ObtenerPorIdAsync(Id);
        if (miTicket?.AsesorId != null) idAsesorSeleccionado = miTicket.AsesorId.Value;
        mensajes = await ServicioChat.ObtenerMensajesPorTicketId(Id);
    }

    private async void ActualizarChatEnVivo(int? ticketIdNotificado, string? t, TipoNotificacion tipo, string? r, Guid? o, Guid? a)
    {
        try
        {
            await InvokeAsync(async () =>
            {
                if (ticketIdNotificado.HasValue && ticketIdNotificado.Value != Id) return;
                await CargarDatosCompletos();
                StateHasChanged();
                await ScrollAlFondo();
            });
        }
        catch
        {
            // Ignoramos el error si el usuario ya salió de la página
        }
    }

    private async Task EnviarMensaje()
    {
        if (enviandoMensaje || (string.IsNullOrWhiteSpace(nuevoMensaje.Contenido) && archivoSeleccionado == null)) return;

        enviandoMensaje = true;
        try
        {
            if (archivoSeleccionado != null)
            {
                nuevoMensaje.AdjuntoUrl = await ServicioChat.SubirArchivoAsync(archivoSeleccionado);
            }

            nuevoMensaje.TicketId = Id;
            nuevoMensaje.FechaHora = DateTime.Now;
            nuevoMensaje.UsuarioId = usuarioActualId;

            await ServicioChat.EnviarMensaje(nuevoMensaje);

            nuevoMensaje = new Mensaje();
            archivoSeleccionado = null;

            // Forzamos el scroll después de que Blazor termine de renderizar el nuevo mensaje
            await InvokeAsync(StateHasChanged);
            await ScrollAlFondo();
        }
        finally
        {
            enviandoMensaje = false;
        }
    }
    private async Task AsignarAsesor()
    {
        if (idAsesorSeleccionado != Guid.Empty && miTicket != null)
        {
            await ServicioTickets.AsignarTicketAsync(miTicket.Id, idAsesorSeleccionado);
            await CargarDatosCompletos();
        }
    }

    private async Task AutoAsignar()
    {
        if (miTicket != null)
        {
            await ServicioTickets.AsignarTicketAsync(miTicket.Id, usuarioActualId);
            await CargarDatosCompletos();
        }
    }

    private async Task MarcarComoResuelto()
    {
        if (miTicket != null)
        {
            await ServicioTickets.ResolverTicketAsync(Id, usuarioActualId);
            await CargarDatosCompletos();
        }
    }

    private async Task GuardarCambios()
    {
        if (miTicket != null)
        {
            await ServicioTickets.ActualizarDescripcionUsuarioAsync(miTicket);
            modoEdicion = false;
        }
    }

    private void CancelarEdicion() => modoEdicion = false;

    private async Task Calificar(int estrellas)
    {
        if (estaCalificando) return;
        estaCalificando = true;

        try
        {
            await ServicioTickets.CalificarTicketAsync(Id, estrellas, usuarioActualId);
            await CargarDatosCompletos();
        }
        finally
        {
            estaCalificando = false;
        }
    }
    // --- UTILIDADES ---
    private void ManejarSeleccionArchivo(InputFileChangeEventArgs e) => archivoSeleccionado = e.File;
    private void VerImagen(string url) => imagenModalUrl = url;
    private void CerrarModal() => imagenModalUrl = null;
    private async Task ScrollAlFondo()
    {
        // Aumentamos ligeramente el delay para asegurar el renderizado del DOM en Server-side
        await Task.Delay(150);
        await JS.InvokeVoidAsync("utilidadesChat.bajarScroll", "chatBox");
    }
    public void Dispose()
    {
        StateContainer.OnChange -= ActualizarChatEnVivo;
    }

    private string ObtenerClaseBadge(EstadoTicket estado) => estado switch
    {
        EstadoTicket.Abierto => "bg-secondary",
        EstadoTicket.Asignado => "bg-primary",
        EstadoTicket.Resuelto => "bg-success",
        _ => "bg-dark"
    };
}