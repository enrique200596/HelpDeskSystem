@page "/login"
@layout HelpDeskSystem.Web.Components.Layout.LoginLayout
@attribute [AllowAnonymous]
@inject NavigationManager Navegacion

<PageTitle>Acceso | HelpDesk UTEPSA</PageTitle>

<div class="container-fluid p-0 w-100 vh-100 overflow-hidden">
    <div class="row g-0 h-100">

        @* === COLUMNA IZQUIERDA: BRANDING (Visible solo en PC) === *@
        <div class="col-lg-7 d-none d-lg-flex flex-column justify-content-center align-items-center text-white position-relative overflow-hidden"
             style="background: linear-gradient(135deg, var(--utepsa-red) 0%, #8a0b20 100%);">

            @* Patrón de fondo sutil (Círculos decorativos) *@
            <div class="position-absolute top-0 start-0 w-100 h-100 opacity-10"
                 style="background-image: radial-gradient(#ffffff 1px, transparent 1px); background-size: 30px 30px;">
            </div>

            <div class="position-relative z-2 text-center px-5 animate-enter">
                <div class="mb-4 p-4 rounded-circle bg-white bg-opacity-10 d-inline-flex">
                    <i class="bi bi-shield-check-fill" style="font-size: 5rem;"></i>
                </div>
                <h1 class="display-4 fw-bold mb-3 ls-1">HelpDesk UTEPSA</h1>
                <p class="lead fs-4 opacity-75 text-balance" style="max-width: 600px;">
                    Plataforma integral para la gestión de servicios y soporte tecnológico universitario.
                </p>
            </div>

            @* Footer decorativo *@
            <div class="position-absolute bottom-0 w-100 text-center pb-4 opacity-50 small">
                &copy; @DateTime.Now.Year Universidad Tecnológica Privada de Santa Cruz
            </div>
        </div>

        @* === COLUMNA DERECHA: FORMULARIO === *@
        <div class="col-lg-5 d-flex flex-column justify-content-center bg-white shadow-pro position-relative">

            <div class="w-100 mx-auto px-4" style="max-width: 480px;">

                @* Encabezado Móvil (Solo visible en pantallas chicas) *@
                <div class="text-center mb-5 d-lg-none">
                    <i class="bi bi-shield-check-fill text-utepsa-red fs-1"></i>
                    <h3 class="fw-bold mt-2">HelpDesk UTEPSA</h3>
                </div>

                @* Encabezado Formulario *@
                <div class="mb-5">
                    <h2 class="fw-bold text-dark mb-2">Bienvenido de nuevo</h2>
                    <p class="text-muted">Ingresa tus credenciales institucionales para continuar.</p>
                </div>

                @if (!string.IsNullOrEmpty(MensajeError))
                {
                    <div class="alert alert-danger d-flex align-items-center mb-4 border-0 shadow-sm rounded-3 animate-enter" role="alert">
                        <i class="bi bi-exclamation-circle-fill me-3 fs-5"></i>
                        <div>@MensajeError</div>
                    </div>
                }

                <form action="/account/login" method="post">
                    <input type="hidden" name="returnUrl" value="@ReturnUrl" />

                    @* Input: Email *@
                    <div class="mb-4">
                        <label class="form-label text-uppercase small text-muted fw-bold ls-1">Correo Institucional</label>
                        <div class="input-group">
                            <span class="input-group-text bg-transparent border-end-0 ps-3 text-muted">
                                <i class="bi bi-envelope"></i>
                            </span>
                            <input type="text" name="email"
                                   class="form-control form-control-pro border-start-0 ps-2 bg-white"
                                   placeholder="ejemplo@utepsa.edu"
                                   autocomplete="username" required />
                        </div>
                    </div>

                    @* Input: Password con Toggle *@
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <label class="form-label text-uppercase small text-muted fw-bold ls-1">Contraseña</label>
                        </div>
                        <div class="input-group">
                            <span class="input-group-text bg-transparent border-end-0 ps-3 text-muted">
                                <i class="bi bi-key"></i>
                            </span>
                            <input type="@(mostrarPassword ? "text" : "password")"
                                   name="password"
                                   class="form-control form-control-pro border-start-0 border-end-0 ps-2 bg-white"
                                   placeholder="••••••••"
                                   autocomplete="current-password" required />

                            <button type="button" class="btn border border-start-0 bg-transparent text-muted"
                                    @onclick="TogglePassword" tabindex="-1">
                                <i class="bi @(mostrarPassword ? "bi-eye-slash-fill" : "bi-eye-fill")"></i>
                            </button>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end mb-4">
                        <a href="#" class="text-decoration-none small text-muted hover-red">¿Olvidaste tu contraseña?</a>
                    </div>

                    @* Botón Submit con Estado de Carga *@
                    <button type="submit" class="btn btn-utepsa w-100 py-3 shadow-sm d-flex justify-content-center align-items-center gap-2"
                            @onclick="IniciarCarga">
                        @if (estaCargando)
                        {
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                            <span>VERIFICANDO...</span>
                        }
                        else
                        {
                            <span>INGRESAR AL SISTEMA</span>
                            <i class="bi bi-arrow-right"></i>
                        }
                    </button>
                </form>

            </div>
        </div>
    </div>
</div>

<style>
    .ls-1 {
        letter-spacing: 1px;
    }

    .opacity-10 {
        opacity: 0.1;
    }

    .bg-app {
        background-color: var(--bg-app);
    }
    /* Ajuste para que el input group se vea unido y limpio */
    .input-group-text {
        border-color: #dee2e6;
        border-radius: var(--radius-md) 0 0 var(--radius-md);
    }

    .input-group .form-control {
        border-radius: 0;
        border-color: #dee2e6;
    }

    .input-group .btn {
        border-color: #dee2e6;
        border-radius: 0 var(--radius-md) var(--radius-md) 0;
    }

    .input-group:focus-within .input-group-text,
    .input-group:focus-within .form-control,
    .input-group:focus-within .btn {
        border-color: var(--utepsa-red);
        z-index: 3;
    }
</style>

@code {
    [SupplyParameterFromQuery(Name = "returnUrl")]
    public string ReturnUrl { get; set; } = "";
    [SupplyParameterFromQuery(Name = "error")]
    public string MensajeError { get; set; } = "";
    private bool mostrarPassword = false;
    private bool estaCargando = false;
    private void TogglePassword() => mostrarPassword = !mostrarPassword;

    private async Task IniciarCarga()
    {
        if (estaCargando) return;

        estaCargando = true;

        // Como el formulario hace un POST tradicional, el navegador debería
        // recargar la página o navegar. Si después de 10 segundos no ha
        // pasado nada, liberamos el botón para que el usuario reintente.
        await Task.Delay(10000);

        estaCargando = false;
        StateHasChanged();
    }
}