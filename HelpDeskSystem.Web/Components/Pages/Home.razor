@page "/"
@attribute [Authorize]
@using HelpDeskSystem.Domain.Entities
@using HelpDeskSystem.Web.Services
@using HelpDeskSystem.Data
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@inject ITicketService ServicioTickets
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Tablero | HelpDesk</PageTitle>

<div class="container-fluid px-4">
    <div class="d-flex justify-content-between align-items-center my-4">
        <div>
            <h2 class="fw-bold text-dark mb-0">Tablero de Tickets</h2>
            <p class="text-muted">Gestión y seguimiento de solicitudes.</p>
        </div>
        @if (rolActual == "Usuario")
        {
            <a href="nuevo-ticket" class="btn btn-primary shadow-sm" title="Crear una nueva solicitud de soporte">
                <i class="bi bi-plus-lg me-2"></i>Nuevo Ticket
            </a>
        }
    </div>

    @if (tickets == null)
    {
        /* Spinner centrado */
        <div class="d-flex justify-content-center mt-5">
            <div class="spinner-border text-utepsa-red" role="status"></div>
        </div>
    }
    else if (tickets.Count == 0)
    {
        /* Estado vacío mejorado */
        <div class="text-center py-5">
            <div class="mb-3 text-muted opacity-25">
                <i class="bi bi-clipboard-check" style="font-size: 5rem;"></i>
            </div>
            <h4>Todo está limpio por aquí</h4>
            <p class="text-muted">No tienes tickets pendientes en este momento.</p>
        </div>
    }
    else
    {
        <div class="row g-4">
            @foreach (var ticket in tickets)
            {
                <div class="col-12 col-md-6 col-lg-4 col-xl-3">
                    <div class="card h-100 card-hover position-relative overflow-hidden">

                        <div class="position-absolute top-0 start-0 bottom-0"
                             style="width: 5px; background-color: @(ticket.EsUrgente ? "#dc3545" : "#28a745");"></div>

                        <div class="card-body ps-4">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="badge rounded-pill bg-light text-dark border">#@ticket.Id</span>
                                <small class="text-muted">@ticket.FechaCreacion.ToString("dd MMM")</small>
                            </div>

                            <h5 class="card-title fw-bold text-truncate mb-1" title="@ticket.Titulo">
                                <a href="/ticket/@ticket.Id" class="text-dark text-decoration-none stretched-link">
                                    @ticket.Titulo
                                </a>
                            </h5>

                            <p class="card-text text-muted small text-truncate mb-3">
                                @ticket.Descripcion
                            </p>

                            <div class="d-flex align-items-center justify-content-between mt-auto pt-3 border-top border-light">
                                @{
                                    var (claseEstado, textoEstado) = ticket.Estado switch
                                    {
                                        var e when e == HelpDeskSystem.Domain.Enums.EstadoTicket.Abierto => ("bg-secondary", "Abierto"),
                                        var e when e == HelpDeskSystem.Domain.Enums.EstadoTicket.Asignado => ("bg-primary", "Asignado"),
                                        var e when e == HelpDeskSystem.Domain.Enums.EstadoTicket.Resuelto => ("bg-success", "Resuelto"),
                                        _ => ("bg-dark", "Otro")
                                    };
                                }
                                <span class="badge @claseEstado bg-opacity-75">@textoEstado</span>

                                <div class="small text-end">
                                    @if (ticket.Asesor != null)
                                    {
                                        <span class="text-success fw-bold" title="Asesor Asignado">
                                            <i class="bi bi-headset me-1"></i>@ticket.Asesor.Nombre
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="text-muted fst-italic">Sin asignar</span>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

<style>
    .ticket-card {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }

        .ticket-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
        }
</style>

@code {
    private List<Ticket>? tickets;
    private Guid usuarioId;
    private string rolActual = "";
    private string nombreUsuario = ""; // Nuevo
    private bool esRolUsuario = false; // Nuevo

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity != null && user.Identity.IsAuthenticated)
        {
            nombreUsuario = user.Identity.Name ?? "Desconocido";
            var idClaim = user.FindFirst(ClaimTypes.Sid) ?? user.FindFirst(ClaimTypes.NameIdentifier);

            if (idClaim != null && Guid.TryParse(idClaim.Value, out var parsedId))
            {
                usuarioId = parsedId;
            }

            // Obtenemos el rol
            rolActual = user.FindFirst(ClaimTypes.Role)?.Value ?? "Sin Rol";

            // Verificamos si el sistema reconoce el rol
            esRolUsuario = user.IsInRole("Usuario");

            tickets = await ServicioTickets.ObtenerTicketsFiltradosAsync(usuarioId, rolActual);
        }
    }
}