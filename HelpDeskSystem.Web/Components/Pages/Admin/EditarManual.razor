@page "/manuales/nuevo"
@page "/manuales/editar/{Id:int}"
@using HelpDeskSystem.Domain.Entities
@using HelpDeskSystem.Web.Services
@using HelpDeskSystem.Web.Auth
@using Microsoft.AspNetCore.Authorization
@using Blazored.TextEditor
@using System.Security.Claims
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Hosting
@inject IManualService ManualService
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JS
@inject IWebHostEnvironment Environment
@attribute [Authorize(Roles = "Administrador,Asesor")]

<PageTitle>@(Id == 0 ? "Nuevo Procedimiento" : "Editar Procedimiento") | HelpDesk</PageTitle>

<div class="container-fluid px-4 py-4">
    <EditForm EditContext="@editContext" OnSubmit="ProcesarGuardado">
        <DataAnnotationsValidator />

        @* --- CABECERA DINÁMICA --- *@
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3 animate-enter">
            <div>
                <h6 class="text-uppercase text-secondary fw-bold mb-1" style="font-size: 0.7rem; letter-spacing: 1.2px; opacity: 0.8;">Editor de Contenido</h6>
                <h2 class="fw-bold text-primary mb-0" style="letter-spacing: -1px;">
                    <i class="bi @(Id == 0 ? "bi-journal-plus" : "bi-journal-text") me-2 text-utepsa-red"></i>
                    @(Id == 0 ? "Crear Nuevo Procedimiento" : "Modificar Guía Técnica")
                </h2>
            </div>

            <div class="d-flex gap-2">
                <button type="button" class="btn btn-utepsa-ghost border fw-bold px-4" @onclick="Volver">DESCARTAR</button>
                <button type="submit" class="btn btn-utepsa shadow-red-glow fw-bold px-4">
                    <i class="bi bi-cloud-arrow-up-fill me-2"></i> PUBLICAR CAMBIOS
                </button>
            </div>
        </div>

        @if (cargando)
        {
            <div class="d-flex flex-column justify-content-center align-items-center py-5">
                <div class="spinner-border text-utepsa-red mb-3" style="width: 3rem; height: 3rem;"></div>
                <span class="text-secondary fw-bold ls-1">PREPARANDO WORKSPACE...</span>
            </div>
        }
        else
        {
            <div class="row">
                <div class="col-12">
                    <ValidationSummary class="alert alert-danger shadow-sm border-0 mb-4" />
                </div>
            </div>

            <div class="row g-4">
                @* === COLUMNA PRINCIPAL: EDITOR === *@
                <div class="col-xl-8 col-lg-7 animate-enter">
                    <div class="card-pro shadow-sm border-0 bg-surface mb-4">
                        <div class="card-pro-header border-bottom py-3 px-4 bg-subtle d-flex justify-content-between align-items-center">
                            <span class="fw-bold text-primary small text-uppercase ls-1">Contenido del Manual</span>
                            <div class="d-flex align-items-center gap-2">
                                <i class="bi bi-info-circle text-secondary" title="Use los estilos de encabezado para una mejor estructura"></i>
                            </div>
                        </div>

                        @* HERRAMIENTA DE IMÁGENES INTEGRADA *@
                        <div class="p-3 bg-light border-bottom d-flex align-items-center gap-3 flex-wrap">
                            <div class="d-flex align-items-center gap-2">
                                <label class="btn btn-dark btn-sm fw-bold px-3 m-0 cursor-pointer">
                                    <i class="bi bi-image me-2"></i>SUBIR IMAGEN
                                    <InputFile OnChange="SubirImagenAlServidor" style="display:none;" accept=".jpg,.png,.jpeg" />
                                </label>
                            </div>

                            @if (!string.IsNullOrEmpty(urlImagenReciente))
                            {
                                <div class="animate-enter d-flex align-items-center bg-white border rounded-pill px-3 py-1 shadow-sm">
                                    <span class="text-success small fw-bold me-3"><i class="bi bi-check-circle-fill"></i> Imagen lista</span>
                                    <button type="button" class="btn btn-primary btn-sm rounded-pill px-3" @onclick="InsertarImagenEnEditor">
                                        INSERTAR
                                    </button>
                                </div>
                            }

                            @if (!string.IsNullOrEmpty(mensajeErrorImagen))
                            {
                                <span class="text-danger small fw-bold animate-enter">@mensajeErrorImagen</span>
                            }
                        </div>

                        <div class="card-pro-body p-0 editor-container-pro">
                            <BlazoredTextEditor @ref="@QuillHtml" Placeholder="Comienza a redactar el procedimiento paso a paso...">
                                <ToolbarContent>
                                    <select class="ql-header">
                                        <option selected=""></option>
                                        <option value="1"></option>
                                        <option value="2"></option>
                                        <option value="3"></option>
                                    </select>
                                    <span class="ql-formats">
                                        <button class="ql-bold"></button>
                                        <button class="ql-italic"></button>
                                        <button class="ql-underline"></button>
                                    </span>
                                    <span class="ql-formats">
                                        <select class="ql-color"></select>
                                        <select class="ql-background"></select>
                                    </span>
                                    <span class="ql-formats">
                                        <button class="ql-list" value="ordered"></button>
                                        <button class="ql-list" value="bullet"></button>
                                    </span>
                                    <span class="ql-formats">
                                        <button class="ql-link"></button>
                                        <button class="ql-clean"></button>
                                    </span>
                                </ToolbarContent>
                            </BlazoredTextEditor>
                        </div>
                    </div>
                </div>

                @* === COLUMNA LATERAL: METADATOS === *@
                <div class="col-xl-4 col-lg-5 animate-enter" style="animation-delay: 0.1s;">
                    <div class="card-pro shadow-sm border-0 bg-surface sticky-top" style="top: 20px;">
                        <div class="card-pro-header border-bottom py-3 px-4 bg-subtle">
                            <h6 class="mb-0 fw-bold text-primary small text-uppercase ls-1">Configuración del Recurso</h6>
                        </div>

                        <div class="card-pro-body p-4">
                            @* Título *@
                            <div class="mb-4">
                                <label class="form-label text-secondary fw-bold small text-uppercase ls-1">Título de la Guía</label>
                                <InputText class="form-control-pro w-100" @bind-Value="manual.Titulo" placeholder="Ej: Configuración VPN UTEPSA" />
                                <ValidationMessage For="@(() => manual.Titulo)" />
                            </div>

                            @* Etiquetas *@
                            <div class="mb-4">
                                <label class="form-label text-secondary fw-bold small text-uppercase ls-1">Etiquetas (Separadas por coma)</label>
                                <div class="position-relative">
                                    <span class="position-absolute top-50 start-0 translate-middle-y ms-3 text-secondary"><i class="bi bi-tags"></i></span>
                                    <InputText class="form-control-pro w-100 ps-5" @bind-Value="etiquetasInput" placeholder="Redes, Seguridad, Alumnos" />
                                </div>
                            </div>

                            @* Visibilidad *@
                            <div class="mb-4">
                                <label class="form-label text-secondary fw-bold small text-uppercase ls-1">Alcance / Visibilidad</label>
                                <div class="position-relative">
                                    <InputSelect class="form-control-pro w-100 appearance-none shadow-none" @bind-Value="rolSeleccionado">
                                        <option value="">Todo el público</option>
                                        <option value="Administrador">Solo Administradores</option>
                                        <option value="Administrador,Asesor">Admin y Asesores (Interno)</option>
                                    </InputSelect>
                                    <i class="bi bi-chevron-down position-absolute end-0 top-50 translate-middle-y me-3 text-secondary pointer-events-none"></i>
                                </div>
                            </div>

                            @* Estado Switch *@
                            <div class="p-3 rounded-3 border bg-subtle">
                                <div class="form-check form-switch d-flex align-items-center gap-3 p-0 ms-4">
                                    <InputCheckbox class="form-check-input mt-0" @bind-Value="manual.IsActive" id="switchActivo" style="width: 40px; height: 20px; cursor: pointer;" />
                                    <label class="form-check-label fw-bold text-primary small" for="switchActivo">Habilitar publicación inmediatamente</label>
                                </div>
                            </div>

                            <div class="mt-4 pt-4 border-top">
                                <div class="alert alert-secondary bg-light border-0 small mb-0 d-flex align-items-start">
                                    <i class="bi bi-info-circle-fill me-2 mt-1"></i>
                                    <span>Los cambios se auditan automáticamente para garantizar la trazabilidad del conocimiento.</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    </EditForm>
</div>

@code {
    [Parameter] public int Id { get; set; }

    private Manual manual = new();
    private BlazoredTextEditor QuillHtml = default!;
    private EditContext? editContext;
    private bool cargando = true;
    private string urlImagenReciente = "";
    private string mensajeErrorImagen = "";
    private string etiquetasInput = "";
    private string rolSeleccionado = "";

    protected override async Task OnInitializedAsync()
    {
        if (Id != 0)
        {
            var existente = await ManualService.ObtenerPorIdAsync(Id);
            if (existente != null)
            {
                manual = existente;
                if (manual.ManualEtiquetas != null)
                    etiquetasInput = string.Join(", ", manual.ManualEtiquetas.Select(e => e.Etiqueta));

                if (manual.RolesVisibles != null && manual.RolesVisibles.Any())
                    rolSeleccionado = string.Join(",", manual.RolesVisibles.Select(r => r.RolNombre));
            }
        }

        editContext = new EditContext(manual);
        cargando = false;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender && QuillHtml != null && !string.IsNullOrEmpty(manual.ContenidoHTML))
        {
            await Task.Delay(200); // Buffer de carga para el editor JS
            try
            {
                var contenidoActual = await QuillHtml.GetHTML();
                if (string.IsNullOrWhiteSpace(contenidoActual) || contenidoActual == "<p><br></p>")
                {
                    await QuillHtml.LoadHTMLContent(manual.ContenidoHTML);
                }
            }
            catch { /* Silencio operativo para evitar parpadeos */ }
        }
    }

    private async Task SubirImagenAlServidor(InputFileChangeEventArgs e)
    {
        mensajeErrorImagen = "";
        var file = e.File;
        if (file == null) return;

        long maxFileSize = 5 * 1024 * 1024;
        if (file.Size > maxFileSize) { mensajeErrorImagen = "Límite: 5MB."; return; }

        try
        {
            var pathCarpeta = Path.Combine(Environment.WebRootPath, "uploads", "manuales");
            if (!Directory.Exists(pathCarpeta)) Directory.CreateDirectory(pathCarpeta);

            var ext = Path.GetExtension(file.Name).ToLower();
            var nombreArchivo = $"{Guid.NewGuid()}{ext}";
            var pathCompleto = Path.Combine(pathCarpeta, nombreArchivo);

            await using FileStream fs = new(pathCompleto, FileMode.Create);
            await file.OpenReadStream(maxFileSize).CopyToAsync(fs);

            urlImagenReciente = $"/uploads/manuales/{nombreArchivo}";
        }
        catch { mensajeErrorImagen = "Error al procesar archivo."; }
    }

    private async Task InsertarImagenEnEditor()
    {
        if (!string.IsNullOrEmpty(urlImagenReciente))
        {
            await QuillHtml.InsertImage(urlImagenReciente);
            urlImagenReciente = "";
        }
    }

    private async Task ProcesarGuardado()
    {
        var htmlContenido = await QuillHtml.GetHTML();

        // --- APLICACIÓN DE LÓGICA DE DOMINIO (100/100) ---
        // Usamos los métodos de la entidad para asegurar la integridad de datos
        manual.ActualizarContenido(manual.Titulo, htmlContenido);
        manual.SetEstado(manual.IsActive);

        // Procesar Etiquetas mediante método de dominio
        // Reemplaza las líneas 210-211 por:
        var tags = etiquetasInput.Split(',', StringSplitOptions.RemoveEmptyEntries)
                                 .Select(t => t.Trim());

        // El método AgregarEtiqueta en Manual.cs ya maneja la lógica de no duplicados
        foreach (var tag in tags) manual.AsignarEtiquetas(tags);

        // Procesar Roles mediante método de dominio
        var roles = rolSeleccionado.Split(',', StringSplitOptions.RemoveEmptyEntries);
        manual.AsignarRolesVisibilidad(roles);

        if (editContext != null && editContext.Validate())
        {
            await GuardarSeguro();
        }
        else
        {
            await JS.InvokeVoidAsync("verificarYNotificar", "Verifica los campos obligatorios.", "error", false);
        }
    }

    private async Task GuardarSeguro()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var claimId = user.FindFirst(ClaimTypes.NameIdentifier);

        if (claimId == null || !Guid.TryParse(claimId.Value, out Guid usuarioEditorId))
        {
            await JS.InvokeVoidAsync("verificarYNotificar", "Sesión inválida.", "error", true);
            return;
        }

        try
        {
            await ManualService.GuardarManualAsync(manual, usuarioEditorId);
            await JS.InvokeVoidAsync("verificarYNotificar", "Cambios publicados.", "success", false);
            Nav.NavigateTo("/manuales");
        }
        catch
        {
            await JS.InvokeVoidAsync("verificarYNotificar", "Error al persistir datos.", "error", false);
        }
    }

    private void Volver() => Nav.NavigateTo("/manuales");
}