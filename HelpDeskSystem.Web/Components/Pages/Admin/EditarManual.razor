@page "/manuales/nuevo"
@page "/manuales/editar/{Id:int}"
@using HelpDeskSystem.Domain.Entities
@using HelpDeskSystem.Web.Services
@using HelpDeskSystem.Web.Auth
@using Microsoft.AspNetCore.Authorization
@using Blazored.TextEditor
@using System.Security.Claims
@inject IManualService ManualService
@inject IUsuarioService UsuarioService
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JS
@attribute [Authorize(Roles = "Administrador,Asesor")]

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>@(Id == 0 ? "Crear Nuevo Procedimiento" : "Editar Procedimiento")</h3>
        <button class="btn btn-secondary" @onclick="Volver">Cancelar</button>
    </div>

    @if (cargando)
    {
        <div class="alert alert-info">Cargando editor...</div>
    }
    else
    {
        <div class="card shadow p-4">
            <div class="mb-3">
                <label class="form-label fw-bold">Título del Procedimiento</label>
                <input type="text" class="form-control form-control-lg" @bind="manual.Titulo" placeholder="Ej: Cómo crear un usuario..." />
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label fw-bold">Etiquetas (Separadas por coma)</label>
                    <input type="text" class="form-control" @bind="manual.Etiquetas" placeholder="Ej: Redes, Impresoras, RRHH" />
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-bold">Roles Permitidos (Vacío = Público)</label>
                    <select class="form-select" @bind="manual.RolesVisibles">
                        <option value="">Todos (Público)</option>
                        <option value="Administrador">Solo Administradores</option>
                        <option value="Administrador,Asesor">Administradores y Asesores</option>
                    </select>
                </div>
            </div>

            <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" @bind="manual.IsActive" id="switchActivo">
                <label class="form-check-label" for="switchActivo">Manual Activo (Visible)</label>
            </div>

            <div class="mb-2 p-2 bg-light border rounded d-flex align-items-center gap-2">
                <span class="fw-bold small"><i class="bi bi-image"></i> Insertar Imagen:</span>
                <InputFile OnChange="SubirImagenAlServidor" class="form-control form-control-sm w-auto" accept=".jpg,.png,.jpeg" />
                @if (!string.IsNullOrEmpty(urlImagenReciente))
                {
                    <span class="text-success small ms-2">Imagen subida.</span>
                    <button class="btn btn-sm btn-outline-primary" @onclick="InsertarImagenEnEditor">Insertar en Editor</button>
                }
            </div>

            <div class="mb-4">
                <BlazoredTextEditor @ref="@QuillHtml">
                    <ToolbarContent>
                        <select class="ql-header">
                            <option selected=""></option>
                            <option value="1"></option>
                            <option value="2"></option>
                            <option value="3"></option>
                        </select>
                        <span class="ql-formats">
                            <button class="ql-bold"></button>
                            <button class="ql-italic"></button>
                            <button class="ql-underline"></button>
                            <button class="ql-strike"></button>
                        </span>
                        <span class="ql-formats">
                            <select class="ql-color"></select>
                            <select class="ql-background"></select>
                        </span>
                        <span class="ql-formats">
                            <button class="ql-list" value="ordered"></button>
                            <button class="ql-list" value="bullet"></button>
                        </span>
                        <span class="ql-formats">
                            <button class="ql-link"></button>
                            <button class="ql-image"></button>
                        </span>
                    </ToolbarContent>
                    <EditorContent>
                    </EditorContent>
                </BlazoredTextEditor>
            </div>

            <button class="btn btn-primary btn-lg w-100" @onclick="Guardar">
                <i class="bi bi-save"></i> Guardar Manual
            </button>
        </div>
    }
</div>

@code {
    [Parameter] public int Id { get; set; }
    private Manual manual = new();
    private BlazoredTextEditor QuillHtml = default!;
    private bool cargando = true;
    private string urlImagenReciente = "";

    protected override async Task OnInitializedAsync()
    {
        if (Id != 0)
        {
            var existente = await ManualService.ObtenerPorIdAsync(Id);
            if (existente != null) manual = existente;
        }
        cargando = false;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender && QuillHtml != null && !string.IsNullOrEmpty(manual.ContenidoHTML))
        {
            await Task.Delay(100);
            try { await QuillHtml.LoadHTMLContent(manual.ContenidoHTML); } catch { }
        }
    }

    private async Task SubirImagenAlServidor(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file != null)
        {
            var path = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", "uploads", "manuales");
            if (!Directory.Exists(path)) Directory.CreateDirectory(path);

            var nombreSeguro = Path.GetFileNameWithoutExtension(file.Name).Replace(" ", "_");
            var ext = Path.GetExtension(file.Name);
            var nombreArchivo = $"{Guid.NewGuid()}_{nombreSeguro}{ext}";

            var pathCompleto = Path.Combine(path, nombreArchivo);
            await using FileStream fs = new(pathCompleto, FileMode.Create);
            await file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024).CopyToAsync(fs);

            urlImagenReciente = $"/uploads/manuales/{nombreArchivo}";
        }
    }

    private async Task InsertarImagenEnEditor()
    {
        if (!string.IsNullOrEmpty(urlImagenReciente))
        {
            await QuillHtml.InsertImage(urlImagenReciente);
            urlImagenReciente = "";
        }
    }

    private async Task Guardar()
    {
        manual.ContenidoHTML = await QuillHtml.GetHTML();

        if (string.IsNullOrWhiteSpace(manual.Titulo) || string.IsNullOrWhiteSpace(manual.ContenidoHTML))
        {
            return;
        }

        // --- CORRECCIÓN DEFINITIVA DE DETECCIÓN DE USUARIO ---
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        Guid usuarioEditorId = Guid.Empty;

        // INTENTO 1: Buscar ID directo en los Claims (Lo más seguro)
        var claimId = user.FindFirst(ClaimTypes.NameIdentifier);
        if (claimId != null && Guid.TryParse(claimId.Value, out Guid parsedId))
        {
            usuarioEditorId = parsedId;
        }

        // INTENTO 2: Si no hay ID, buscar por Email en la BD
        if (usuarioEditorId == Guid.Empty)
        {
            var claimEmail = user.FindFirst(ClaimTypes.Email) ?? user.FindFirst(ClaimTypes.Name);
            if (claimEmail != null)
            {
                var usuarioDb = await UsuarioService.ObtenerPorEmailAsync(claimEmail.Value);
                if (usuarioDb != null)
                {
                    usuarioEditorId = usuarioDb.Id;
                }
            }
        }

        // INTENTO 3 (Fallback): Si todo falla, usar el Admin Semilla (para que no explote)
        if (usuarioEditorId == Guid.Empty)
        {
            // ID del Admin Semilla (Evita error de FK en SQL, pero marca como Admin en historial)
            usuarioEditorId = Guid.Parse("11111111-1111-1111-1111-111111111111");
        }

        // Pasamos el ID detectado
        await ManualService.GuardarManualAsync(manual, usuarioEditorId);
        // -----------------------------

        Nav.NavigateTo("/manuales");
    }

    private void Volver()
    {
        Nav.NavigateTo("/manuales");
    }
}