@page "/manuales/nuevo"
@page "/manuales/editar/{Id:int}"
@using HelpDeskSystem.Domain.Entities
@using HelpDeskSystem.Web.Services
@using HelpDeskSystem.Web.Auth
@using Microsoft.AspNetCore.Authorization
@using Blazored.TextEditor
@using System.Security.Claims
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Hosting
@inject IManualService ManualService
@inject IUsuarioService UsuarioService
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JS
@inject IWebHostEnvironment Environment
@attribute [Authorize(Roles = "Administrador,Asesor")]

<PageTitle>@(Id == 0 ? "Nuevo Procedimiento" : "Editar Procedimiento") | HelpDesk</PageTitle>

<div class="container-fluid px-4 py-4">
    @* Usamos EditContext para tener control total sobre el momento de la validación (necesario por el editor Quill asíncrono) *@
    <EditForm EditContext="@editContext" OnSubmit="ProcesarGuardado">
        <DataAnnotationsValidator />

        @* --- CABECERA DINÁMICA --- *@
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3 animate-enter">
            <div>
                <h6 class="text-uppercase text-secondary fw-bold mb-1" style="font-size: 0.7rem; letter-spacing: 1.2px; opacity: 0.8;">Editor de Contenido</h6>
                <h2 class="fw-bold text-primary mb-0" style="letter-spacing: -1px;">
                    <i class="bi @(Id == 0 ? "bi-journal-plus" : "bi-journal-text") me-2 text-utepsa-red"></i>
                    @(Id == 0 ? "Crear Nuevo Procedimiento" : "Modificar Guía Técnica")
                </h2>
            </div>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-utepsa-ghost border fw-bold px-4" @onclick="Volver">DESCARTAR</button>
                <button type="submit" class="btn btn-utepsa shadow-red-glow fw-bold px-4">
                    <i class="bi bi-cloud-arrow-up-fill me-2"></i> PUBLICAR CAMBIOS
                </button>
            </div>
        </div>

        @if (cargando)
        {
            <div class="d-flex flex-column justify-content-center align-items-center py-5">
                <div class="spinner-border text-utepsa-red mb-3" style="width: 3rem; height: 3rem;"></div>
                <span class="text-secondary fw-bold ls-1">PREPARANDO WORKSPACE...</span>
            </div>
        }
        else
        {
            @* Muestra resumen de errores si la validación falla *@
            <div class="row">
                <div class="col-12">
                    <ValidationSummary class="alert alert-danger shadow-sm border-0 mb-4" />
                </div>
            </div>

            <div class="row g-4">
                @* === COLUMNA PRINCIPAL: EDITOR === *@
                <div class="col-xl-8 col-lg-7 animate-enter">
                    <div class="card-pro shadow-sm border-0 bg-surface mb-4">
                        <div class="card-pro-header border-bottom py-3 px-4 bg-subtle d-flex justify-content-between align-items-center">
                            <span class="fw-bold text-primary small text-uppercase ls-1">Contenido del Manual</span>
                            <div class="d-flex align-items-center gap-2">
                                <i class="bi bi-info-circle text-secondary" title="Use los estilos de encabezado para una mejor estructura"></i>
                            </div>
                        </div>

                        @* HERRAMIENTA DE IMÁGENES INTEGRADA *@
                        <div class="p-3 bg-light border-bottom d-flex align-items-center gap-3 flex-wrap">
                            <div class="d-flex align-items-center gap-2">
                                <label class="btn btn-dark btn-sm fw-bold px-3 m-0 cursor-pointer">
                                    <i class="bi bi-image me-2"></i>SUBIR IMAGEN
                                    <InputFile OnChange="SubirImagenAlServidor" style="display:none;" accept=".jpg,.png,.jpeg" />
                                </label>
                            </div>

                            @if (!string.IsNullOrEmpty(urlImagenReciente))
                            {
                                <div class="animate-enter d-flex align-items-center bg-white border rounded-pill px-3 py-1 shadow-sm">
                                    <span class="text-success small fw-bold me-3"><i class="bi bi-check-circle-fill"></i> Lista para insertar</span>
                                    <button type="button" class="btn btn-primary btn-sm rounded-pill px-3" @onclick="InsertarImagenEnEditor">
                                        INSERTAR EN EL TEXTO
                                    </button>
                                </div>
                            }

                            @if (!string.IsNullOrEmpty(mensajeErrorImagen))
                            {
                                <span class="text-danger small fw-bold animate-enter">@mensajeErrorImagen</span>
                            }
                        </div>

                        <div class="card-pro-body p-0 editor-container-pro">
                            @* El editor Quill no es un input nativo, se gestiona manualmente al guardar *@
                            <BlazoredTextEditor @ref="@QuillHtml" Placeholder="Comienza a redactar el procedimiento paso a paso...">
                                <ToolbarContent>
                                    <select class="ql-header">
                                        <option selected=""></option>
                                        <option value="1"></option>
                                        <option value="2"></option>
                                        <option value="3"></option>
                                    </select>
                                    <span class="ql-formats">
                                        <button class="ql-bold"></button>
                                        <button class="ql-italic"></button>
                                        <button class="ql-underline"></button>
                                    </span>
                                    <span class="ql-formats">
                                        <select class="ql-color"></select>
                                        <select class="ql-background"></select>
                                    </span>
                                    <span class="ql-formats">
                                        <button class="ql-list" value="ordered"></button>
                                        <button class="ql-list" value="bullet"></button>
                                    </span>
                                    <span class="ql-formats">
                                        <button class="ql-link"></button>
                                        <button class="ql-clean"></button>
                                    </span>
                                </ToolbarContent>
                            </BlazoredTextEditor>
                        </div>
                        @* Mensaje de validación específico para el contenido HTML *@
                        <div class="px-4 py-2">
                            <ValidationMessage For="@(() => manual.ContenidoHTML)" />
                        </div>
                    </div>
                </div>

                @* === COLUMNA LATERAL: METADATOS === *@
                <div class="col-xl-4 col-lg-5 animate-enter" style="animation-delay: 0.1s;">
                    <div class="card-pro shadow-sm border-0 bg-surface sticky-top" style="top: 20px;">
                        <div class="card-pro-header border-bottom py-3 px-4 bg-subtle">
                            <h6 class="mb-0 fw-bold text-primary small text-uppercase ls-1">Configuración del Recurso</h6>
                        </div>

                        <div class="card-pro-body p-4">
                            @* Título *@
                            <div class="mb-4">
                                <label class="form-label text-secondary fw-bold small text-uppercase ls-1">Título de la Guía</label>
                                <InputText class="form-control-pro w-100" @bind-Value="manual.Titulo" placeholder="Ej: Configuración VPN UTEPSA" />
                                <ValidationMessage For="@(() => manual.Titulo)" />
                            </div>

                            @* Etiquetas *@
                            <div class="mb-4">
                                <label class="form-label text-secondary fw-bold small text-uppercase ls-1">Etiquetas (Separadas por coma)</label>
                                <div class="position-relative">
                                    <span class="position-absolute top-50 start-0 translate-middle-y ms-3 text-secondary"><i class="bi bi-tags"></i></span>
                                    <InputText class="form-control-pro w-100 ps-5" @bind-Value="manual.Etiquetas" placeholder="Redes, Seguridad, Alumnos" />
                                </div>
                                <ValidationMessage For="@(() => manual.Etiquetas)" />
                            </div>

                            @* Visibilidad *@
                            <div class="mb-4">
                                <label class="form-label text-secondary fw-bold small text-uppercase ls-1">Alcance / Visibilidad</label>
                                <div class="position-relative">
                                    <InputSelect class="form-control-pro w-100 appearance-none shadow-none" @bind-Value="manual.RolesVisibles">
                                        <option value="">Todo el público</option>
                                        <option value="Administrador">Solo Administradores</option>
                                        <option value="Administrador,Asesor">Admin y Asesores (Interno)</option>
                                    </InputSelect>
                                    <i class="bi bi-chevron-down position-absolute end-0 top-50 translate-middle-y me-3 text-secondary pointer-events-none"></i>
                                </div>
                            </div>

                            @* Estado Switch *@
                            <div class="p-3 rounded-3 border bg-subtle">
                                <div class="form-check form-switch d-flex align-items-center gap-3 p-0 ms-4">
                                    <InputCheckbox class="form-check-input mt-0" @bind-Value="manual.IsActive" id="switchActivo" style="width: 40px; height: 20px; cursor: pointer;" />
                                    <label class="form-check-label fw-bold text-primary small" for="switchActivo">Habilitar publicación inmediatamente</label>
                                </div>
                            </div>

                            <div class="mt-4 pt-4 border-top">
                                <div class="alert alert-secondary bg-light border-0 small mb-0 d-flex align-items-start">
                                    <i class="bi bi-info-circle-fill me-2 mt-1"></i>
                                    <span>Los cambios en el título y etiquetas se sincronizan automáticamente con el motor de búsqueda.</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    </EditForm>
</div>

<style>
    .ls-1 {
        letter-spacing: 1px;
    }

    .bg-surface {
        background-color: var(--bg-surface) !important;
    }

    .bg-subtle {
        background-color: var(--bg-subtle) !important;
    }

    .text-primary {
        color: var(--text-primary) !important;
    }

    .text-secondary {
        color: var(--text-secondary) !important;
    }

    .appearance-none {
        -webkit-appearance: none;
        appearance: none;
    }

    .pointer-events-none {
        pointer-events: none;
    }

    /* Personalización del Editor Quill */
    .editor-container-pro .ql-toolbar {
        border: none !important;
        background-color: var(--bg-subtle);
        border-bottom: 1px solid var(--border-color) !important;
        padding: 10px 15px !important;
    }

    .editor-container-pro .ql-container {
        border: none !important;
        min-height: 500px;
        font-family: 'Inter', system-ui, sans-serif;
        font-size: 1.05rem;
    }

    .editor-container-pro .ql-editor {
        padding: 30px 40px !important;
    }

        .editor-container-pro .ql-editor.ql-blank::before {
            font-style: normal;
            opacity: 0.5;
            left: 40px;
        }
</style>

@code {
    [Parameter] public int Id { get; set; }

    private Manual manual = new();
    private BlazoredTextEditor QuillHtml = default!;
    private EditContext? editContext;
    private bool cargando = true;
    private string urlImagenReciente = "";
    private string mensajeErrorImagen = "";

    protected override async Task OnInitializedAsync()
    {
        if (Id != 0)
        {
            var existente = await ManualService.ObtenerPorIdAsync(Id);
            if (existente != null) manual = existente;
        }

        // Inicializamos el EditContext con el modelo
        editContext = new EditContext(manual);
        cargando = false;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender && QuillHtml != null && !string.IsNullOrEmpty(manual.ContenidoHTML))
        {
            // Pequeño delay para asegurar que Quill esté listo en el DOM
            await Task.Delay(150);
            try
            {
                // Solo cargamos si el editor está vacío para evitar sobrescribir si el usuario ya escribió algo antes del render
                var contenidoActual = await QuillHtml.GetHTML();
                if (string.IsNullOrWhiteSpace(contenidoActual))
                {
                    await QuillHtml.LoadHTMLContent(manual.ContenidoHTML);
                }
            }
            catch { }
        }
    }

    private async Task SubirImagenAlServidor(InputFileChangeEventArgs e)
    {
        mensajeErrorImagen = "";
        var file = e.File;
        if (file == null) return;

        // Validación 1: Tamaño (Max 5MB)
        long maxFileSize = 5 * 1024 * 1024;
        if (file.Size > maxFileSize)
        {
            mensajeErrorImagen = "La imagen supera el límite de 5MB.";
            return;
        }

        try
        {
            // Validación 2: Cabeceras Reales (Magic Numbers) para seguridad anti-malware
            var buffer = new byte[8];
            using (var stream = file.OpenReadStream(maxFileSize))
            {
                await stream.ReadAsync(buffer, 0, 8);
            }

            // Firmas: JPG (FF D8 F0), PNG (89 50 4E 47)
            bool esImagenValida = false;
            if (buffer[0] == 0xFF && buffer[1] == 0xD8) esImagenValida = true; // JPG
            if (buffer[0] == 0x89 && buffer[1] == 0x50 && buffer[2] == 0x4E && buffer[3] == 0x47) esImagenValida = true; // PNG

            if (!esImagenValida)
            {
                mensajeErrorImagen = "El archivo no es una imagen válida o está dañado.";
                return;
            }

            // Guardado Seguro
            var pathCarpeta = Path.Combine(Environment.WebRootPath, "uploads", "manuales");
            if (!Directory.Exists(pathCarpeta)) Directory.CreateDirectory(pathCarpeta);

            var nombreSeguro = Path.GetFileNameWithoutExtension(file.Name).Replace(" ", "_");
            // Limitar longitud de nombre
            if (nombreSeguro.Length > 50) nombreSeguro = nombreSeguro.Substring(0, 50);

            var ext = Path.GetExtension(file.Name).ToLower();
            var nombreArchivo = $"{Guid.NewGuid()}_{nombreSeguro}{ext}";
            var pathCompleto = Path.Combine(pathCarpeta, nombreArchivo);

            await using FileStream fs = new(pathCompleto, FileMode.Create);
            // Volvemos a abrir el stream para copiar todo el contenido
            await file.OpenReadStream(maxFileSize).CopyToAsync(fs);

            urlImagenReciente = $"/uploads/manuales/{nombreArchivo}";
        }
        catch (Exception ex)
        {
            mensajeErrorImagen = "Error al procesar la imagen.";
            Console.WriteLine(ex.Message);
        }
    }

    private async Task InsertarImagenEnEditor()
    {
        if (!string.IsNullOrEmpty(urlImagenReciente))
        {
            await QuillHtml.InsertImage(urlImagenReciente);
            urlImagenReciente = "";
            mensajeErrorImagen = "";
        }
    }

    private async Task ProcesarGuardado()
    {
        // 1. Sincronizar contenido del editor visual al modelo antes de validar
        manual.ContenidoHTML = await QuillHtml.GetHTML();

        // 2. Ejecutar validación explícita (DataAnnotations)
        if (editContext != null && editContext.Validate())
        {
            await GuardarSeguro();
        }
        else
        {
            await JS.InvokeVoidAsync("verificarYNotificar", "Por favor corrige los errores en el formulario.", "error", false);
        }
    }

    private async Task GuardarSeguro()
    {
        // Verificación de integridad de sesión (Defensa en profundidad)
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var claimId = user.FindFirst(ClaimTypes.NameIdentifier);

        if (claimId == null || !Guid.TryParse(claimId.Value, out Guid usuarioEditorId))
        {
            // CRÍTICO: No usamos GUIDs hardcodeados. Si no hay usuario, abortamos.
            await JS.InvokeVoidAsync("verificarYNotificar", "Error de sesión. Recargue la página.", "error", true);
            return;
        }

        try
        {
            await ManualService.GuardarManualAsync(manual, usuarioEditorId);
            await JS.InvokeVoidAsync("verificarYNotificar", "Manual guardado con éxito", "success", false);
            Nav.NavigateTo("/manuales");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("verificarYNotificar", "Error interno al guardar los datos.", "error", false);
        }
    }

    private void Volver() => Nav.NavigateTo("/manuales");
}