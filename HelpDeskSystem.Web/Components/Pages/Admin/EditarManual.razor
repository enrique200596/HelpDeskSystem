@page "/manuales/nuevo"
@page "/manuales/editar/{Id:int}"
@using HelpDeskSystem.Domain.Entities
@using HelpDeskSystem.Web.Services
@using HelpDeskSystem.Web.Auth
@using Microsoft.AspNetCore.Authorization
@using Blazored.TextEditor
@using System.Security.Claims
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Hosting
@inject IManualService ManualService
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JS
@inject IWebHostEnvironment Environment
@attribute [Authorize(Roles = "Administrador,Asesor")]

<PageTitle>@(Id == 0 ? "Nuevo Procedimiento" : "Editar Procedimiento") | HelpDesk</PageTitle>

<div class="container-fluid px-4 py-4">
    <EditForm EditContext="@editContext" OnSubmit="ProcesarGuardado">
        <DataAnnotationsValidator />

        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3 animate-enter">
            <div>
                <h6 class="text-uppercase text-secondary fw-bold mb-1" style="font-size: 0.7rem; letter-spacing: 1.2px; opacity: 0.8;">Editor de Contenido</h6>
                <h2 class="fw-bold text-primary mb-0" style="letter-spacing: -1px;">
                    <i class="bi @(Id == 0 ? "bi-journal-plus" : "bi-journal-text") me-2 text-danger"></i>
                    @(Id == 0 ? "Crear Nuevo Procedimiento" : "Modificar Guía Técnica")
                </h2>
            </div>

            <div class="d-flex gap-2">
                <button type="button" class="btn btn-outline-secondary fw-bold px-4" @onclick="Volver">DESCARTAR</button>
                <button type="submit" class="btn btn-primary shadow fw-bold px-4">
                    <i class="bi bi-cloud-arrow-up-fill me-2"></i> PUBLICAR CAMBIOS
                </button>
            </div>
        </div>

        @if (cargando)
        {
            <div class="d-flex flex-column justify-content-center align-items-center py-5">
                <div class="spinner-border text-danger mb-3" style="width: 3rem; height: 3rem;"></div>
                <span class="text-secondary fw-bold ls-1">PREPARANDO WORKSPACE...</span>
            </div>
        }
        else
        {
            <div class="row g-4">
                <div class="col-xl-8 col-lg-7 animate-enter">
                    <div class="card shadow-sm border-0 mb-4">
                        <div class="card-header border-bottom py-3 px-4 bg-light d-flex justify-content-between align-items-center">
                            <span class="fw-bold text-primary small text-uppercase">Contenido del Manual</span>
                        </div>

                        <div class="p-3 bg-light border-bottom d-flex align-items-center gap-3 flex-wrap">
                            <label class="btn btn-dark btn-sm fw-bold px-3 m-0 cursor-pointer">
                                <i class="bi bi-image me-2"></i>SUBIR IMAGEN
                                <InputFile OnChange="SubirImagenAlServidor" style="display:none;" accept=".jpg,.png,.jpeg" />
                            </label>

                            @if (!string.IsNullOrEmpty(urlImagenReciente))
                            {
                                <button type="button" class="btn btn-success btn-sm rounded-pill px-3 animate-enter" @onclick="InsertarImagenEnEditor">INSERTAR IMAGEN LISTA</button>
                            }
                        </div>

                        <div class="card-body p-0 editor-container-pro">
                            <BlazoredTextEditor @ref="@QuillHtml" Placeholder="Redacte el procedimiento paso a paso...">
                                <ToolbarContent>
                                    <select class="ql-header">
                                        <option selected=""></option>
                                        <option value="1"></option>
                                        <option value="2"></option>
                                        <option value="3"></option>
                                    </select>
                                    <span class="ql-formats">
                                        <button class="ql-bold"></button>
                                        <button class="ql-italic"></button>
                                        <button class="ql-underline"></button>
                                    </span>
                                    <span class="ql-formats">
                                        <button class="ql-list" value="ordered"></button>
                                        <button class="ql-list" value="bullet"></button>
                                        <button class="ql-link"></button>
                                        <button class="ql-clean"></button>
                                    </span>
                                </ToolbarContent>
                                <EditorContent>
                                    @((MarkupString)manual.ContenidoHTML)
                                </EditorContent>
                            </BlazoredTextEditor>
                        </div>
                    </div>
                </div>

                <div class="col-xl-4 col-lg-5 animate-enter">
                    <div class="card shadow-sm border-0 sticky-top" style="top: 20px;">
                        <div class="card-body p-4">
                            <div class="mb-4">
                                <label class="form-label text-secondary fw-bold small text-uppercase">Título de la Guía</label>
                                <InputText class="form-control w-100" @bind-Value="manual.Titulo" />
                                <ValidationMessage For="@(() => manual.Titulo)" />
                            </div>

                            <div class="mb-4">
                                <label class="form-label text-secondary fw-bold small text-uppercase">Etiquetas</label>
                                <InputText class="form-control w-100" @bind-Value="etiquetasInput" placeholder="Redes, Seguridad" />
                            </div>

                            <div class="mb-4">
                                <label class="form-label text-secondary fw-bold small text-uppercase">Visibilidad</label>
                                <InputSelect class="form-select" @bind-Value="rolSeleccionado">
                                    <option value="">Todo el público</option>
                                    <option value="Administrador">Solo Administradores</option>
                                    <option value="Administrador,Asesor">Admin y Asesores</option>
                                </InputSelect>
                            </div>

                            <div class="form-check form-switch border p-3 rounded">
                                <InputCheckbox class="form-check-input ms-0 me-2" @bind-Value="manual.IsActive" id="switchActivo" />
                                <label class="form-check-label fw-bold" for="switchActivo">Publicar inmediatamente</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    </EditForm>
</div>

@code {
    [Parameter] public int Id { get; set; }
    private Manual manual = new();
    private BlazoredTextEditor QuillHtml = default!;
    private EditContext? editContext;
    private bool cargando = true;
    private string urlImagenReciente = "";
    private string mensajeErrorImagen = "";
    private string etiquetasInput = "";
    private string rolSeleccionado = "";
    private bool contenidoCargadoEnEditor = false;

    protected override async Task OnInitializedAsync()
    {
        if (Id != 0)
        {
            var existente = await ManualService.ObtenerPorIdAsync(Id);
            if (existente != null)
            {
                manual = existente;
                etiquetasInput = string.Join(", ", manual.ManualEtiquetas.Select(e => e.Etiqueta));
                rolSeleccionado = string.Join(",", manual.RolesVisibles.Select(r => r.RolNombre));
            }
        }
        editContext = new EditContext(manual);
        cargando = false;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender && QuillHtml != null && !contenidoCargadoEnEditor && !string.IsNullOrEmpty(manual.ContenidoHTML))
        {
            await Task.Delay(500); // Tiempo para inicialización de Quill
            await QuillHtml.LoadHTMLContent(manual.ContenidoHTML);
            contenidoCargadoEnEditor = true;
            StateHasChanged();
        }
    }

    private async Task SubirImagenAlServidor(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;

        try
        {
            var pathCarpeta = Path.Combine(Environment.WebRootPath, "uploads", "manuales");
            if (!Directory.Exists(pathCarpeta)) Directory.CreateDirectory(pathCarpeta);

            var nombreArchivo = $"{Guid.NewGuid()}{Path.GetExtension(file.Name)}";
            var pathCompleto = Path.Combine(pathCarpeta, nombreArchivo);

            await using FileStream fs = new(pathCompleto, FileMode.Create);
            await file.OpenReadStream(5 * 1024 * 1024).CopyToAsync(fs);

            urlImagenReciente = $"/uploads/manuales/{nombreArchivo}";
        }
        catch { /* Error handling */ }
    }

    private async Task InsertarImagenEnEditor()
    {
        if (!string.IsNullOrEmpty(urlImagenReciente))
        {
            await QuillHtml.InsertImage(urlImagenReciente);
            urlImagenReciente = "";
        }
    }

    private async Task ProcesarGuardado()
    {
        var htmlContenido = await QuillHtml.GetHTML();
        manual.ActualizarContenido(manual.Titulo, htmlContenido);
        manual.SetEstado(manual.IsActive);

        manual.AsignarEtiquetas(etiquetasInput.Split(',', StringSplitOptions.RemoveEmptyEntries).Select(t => t.Trim()));
        manual.AsignarRolesVisibilidad(rolSeleccionado.Split(',', StringSplitOptions.RemoveEmptyEntries));

        if (editContext?.Validate() == true) await GuardarSeguro();
    }

    private async Task GuardarSeguro()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var claimId = authState.User.FindFirst(ClaimTypes.NameIdentifier);

        if (claimId != null && Guid.TryParse(claimId.Value, out Guid uId))
        {
            await ManualService.GuardarManualAsync(manual, uId);
            Nav.NavigateTo("/manuales");
        }
    }

    private void Volver() => Nav.NavigateTo("/manuales");
}