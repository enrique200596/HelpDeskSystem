@page "/admin/categorias"
@attribute [Authorize(Roles = "Administrador")]
@using HelpDeskSystem.Domain.Entities
@using HelpDeskSystem.Web.Services
@inject ITicketService ServicioTickets
@inject IJSRuntime JS

<PageTitle>Categorías | HelpDesk UTEPSA</PageTitle>

<div class="container-fluid px-4 py-4">

    @* --- CABECERA --- *@
    <div class="mb-4 animate-enter">
        <h6 class="text-uppercase text-secondary fw-bold mb-1" style="font-size: 0.7rem; letter-spacing: 1.2px; opacity: 0.8;">Configuración de Sistemas</h6>
        <h2 class="fw-bold text-primary mb-0" style="letter-spacing: -0.5px;">Gestión de Clasificaciones</h2>
    </div>

    <div class="row g-4">
        @* === COLUMNA IZQUIERDA: FORMULARIO (Simetría) === *@
        <div class="col-xl-4 col-lg-5 animate-enter" style="animation-delay: 0.1s;">
            <div class="card-pro shadow-sm border-0 sticky-top" style="top: 20px;">
                <div class="card-pro-header border-bottom py-3 @(modoEdicion ? "bg-subtle border-warning" : "bg-subtle")">
                    <div class="d-flex align-items-center">
                        <div class="bg-surface rounded-circle d-flex align-items-center justify-content-center shadow-sm me-3" style="width: 38px; height: 38px;">
                            <i class="bi @(modoEdicion ? "bi-pencil-fill text-warning" : "bi-tags-fill text-utepsa-red") fs-5"></i>
                        </div>
                        <h6 class="mb-0 fw-bold text-primary">@(modoEdicion ? "Editar Categoría" : "Nueva Categoría")</h6>
                    </div>
                </div>

                <div class="card-pro-body p-4">
                    <EditForm Model="modeloCategoria" OnValidSubmit="Guardar">
                        <DataAnnotationsValidator />

                        <div class="mb-4">
                            <label class="form-label text-secondary fw-bold small text-uppercase ls-1">Nombre Identificador</label>
                            <InputText @bind-Value="modeloCategoria.Nombre" class="form-control-pro w-100" placeholder="Ej: Redes e Infraestructura" />
                            <ValidationMessage For="@(() => modeloCategoria.Nombre)" class="text-danger small mt-1 fw-bold" />
                        </div>

                        <div class="d-flex flex-column gap-2">
                            <button type="submit" class="btn @(modoEdicion ? "btn-warning text-dark" : "btn-utepsa shadow-red-glow") py-2 fw-bold transition-all">
                                <i class="bi @(modoEdicion ? "bi-check-circle-fill" : "bi-plus-circle-fill") me-2"></i>
                                @(modoEdicion ? "ACTUALIZAR CAMBIOS" : "CREAR CATEGORÍA")
                            </button>

                            @if (modoEdicion)
                            {
                                <button type="button" class="btn btn-utepsa-ghost py-2 border text-secondary fw-bold" @onclick="CancelarEdicion">
                                    CANCELAR
                                </button>
                            }
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>

        @* === COLUMNA DERECHA: TABLA DE CATÁLOGO === *@
        <div class="col-xl-8 col-lg-7 animate-enter" style="animation-delay: 0.2s;">
            <div class="card-pro shadow-sm border-0 bg-surface">
                <div class="card-pro-header border-bottom py-3 d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 fw-bold text-primary">Catálogo de Servicios Habilitados</h6>
                    <span class="badge bg-subtle text-secondary border px-2 py-1 small">Total: @listaCategorias.Count</span>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-subtle">
                            <tr class="text-secondary small fw-bold text-uppercase">
                                <th class="ps-4 py-3 border-0" style="letter-spacing: 0.5px;">Descripción</th>
                                <th class="border-0">Estado Operativo</th>
                                <th class="text-end pe-4 border-0">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var cat in listaCategorias)
                            {
                                <tr class="@(cat.IsActive ? "" : "opacity-50") border-bottom border-light">
                                    <td class="ps-4 py-3">
                                        <div class="d-flex align-items-center">
                                            <div class="bg-subtle rounded p-2 me-3 d-flex align-items-center justify-content-center" style="width: 34px; height: 34px;">
                                                <i class="bi bi-folder2-open text-primary fs-5"></i>
                                            </div>
                                            <span class="fw-bold text-primary">@cat.Nombre</span>
                                        </div>
                                    </td>
                                    <td>
                                        @if (cat.IsActive)
                                        {
                                            <span class="badge-pill status-solved" style="font-size: 0.65rem;">
                                                <i class="bi bi-check-circle-fill me-1"></i> ACTIVA
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge-pill bg-light text-secondary border" style="font-size: 0.65rem;">
                                                <i class="bi bi-eye-slash-fill me-1"></i> INACTIVA
                                            </span>
                                        }
                                    </td>
                                    <td class="text-end pe-4">
                                        <div class="btn-group shadow-sm rounded-3 overflow-hidden">
                                            <button class="btn btn-white btn-sm border-end text-primary p-2" @onclick="() => IniciarEdicion(cat)" title="Editar">
                                                <i class="bi bi-pencil-square"></i>
                                            </button>

                                            <button class="btn btn-white btn-sm text-@(cat.IsActive ? "danger" : "success") p-2" @onclick="() => CambiarEstado(cat)" title="@(cat.IsActive ? "Dar de baja" : "Reactivar")">
                                                <i class="bi @(cat.IsActive ? "bi-toggle-on" : "bi-toggle-off") fs-5"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .ls-1 {
        letter-spacing: 1px;
    }

    .bg-surface {
        background-color: var(--bg-surface) !important;
    }

    .bg-subtle {
        background-color: var(--bg-subtle) !important;
    }

    .text-primary {
        color: var(--text-primary) !important;
    }

    .text-secondary {
        color: var(--text-secondary) !important;
    }

    .btn-white {
        background-color: var(--bg-surface);
    }

        .btn-white:hover {
            background-color: var(--bg-subtle);
        }
</style>

@code {
    private Categoria modeloCategoria = new();
    private List<Categoria> listaCategorias = new();
    private bool modoEdicion = false;

    protected override async Task OnInitializedAsync() => await CargarCategorias();

    private async Task CargarCategorias()
    {
        listaCategorias = await ServicioTickets.ObtenerCategoriasAsync(incluirInactivas: true);
    }

    private void IniciarEdicion(Categoria cat)
    {
        modeloCategoria = cat;
        modoEdicion = true;
    }

    private void CancelarEdicion()
    {
        modeloCategoria = new Categoria();
        modoEdicion = false;
    }

    private async Task Guardar()
    {
        if (string.IsNullOrWhiteSpace(modeloCategoria.Nombre)) return;

        if (modoEdicion)
        {
            await ServicioTickets.ActualizarCategoriaAsync(modeloCategoria);
            await JS.InvokeVoidAsync("verificarYNotificar", "Clasificación actualizada", "success", false);
            CancelarEdicion();
        }
        else
        {
            await ServicioTickets.GuardarCategoriaAsync(modeloCategoria);
            await JS.InvokeVoidAsync("verificarYNotificar", "Nueva clasificación creada", "success", false);
            modeloCategoria = new Categoria();
        }
        await CargarCategorias();
    }

    private async Task CambiarEstado(Categoria cat)
    {
        cat.IsActive = !cat.IsActive;
        await ServicioTickets.ActualizarCategoriaAsync(cat);
        string msg = cat.IsActive ? "Clasificación reactivada" : "Clasificación desactivada";
        await JS.InvokeVoidAsync("verificarYNotificar", msg, cat.IsActive ? "success" : "warning", false);
    }
}