@page "/manuales"
@using HelpDeskSystem.Domain.Entities
@using HelpDeskSystem.Web.Services
@using Microsoft.AspNetCore.Authorization
@inject IManualService ManualService
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>📚 Base de Conocimiento</h2>
            <p class="text-muted">Guías y procedimientos paso a paso</p>
        </div>

        <AuthorizeView Roles="Administrador,Asesor">
            <Authorized>
                <button class="btn btn-primary" @onclick="CrearNuevo">
                    <i class="bi bi-plus-lg"></i> Crear Nuevo Manual
                </button>
            </Authorized>
        </AuthorizeView>
    </div>

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="input-group">
                <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                <input type="text" class="form-control border-start-0" placeholder="Buscar procedimiento..."
                       @bind="busqueda" @bind:event="oninput" />
            </div>
        </div>
    </div>

    @if (manuales == null)
    {
        <div class="d-flex justify-content-center p-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
        </div>
    }
    else if (!ManualesFiltrados.Any())
    {
        <div class="alert alert-warning text-center">
            No se encontraron manuales con ese criterio.
        </div>
    }
    else
    {
        <div class="row g-4">
            @foreach (var m in ManualesFiltrados)
            {
                <div class="col-md-6 col-lg-4">
                    <div class="card h-100 shadow-sm hover-card">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title text-primary fw-bold mb-3">
                                <i class="bi bi-file-earmark-text me-2"></i>@m.Titulo
                            </h5>

                            <p class="card-text text-muted small flex-grow-1">
                                Publicado por: <strong>@(m.Autor?.Nombre ?? "Admin")</strong><br />
                                Fecha: @m.FechaCreacion.ToShortDateString()
                            </p>

                            <div class="mt-3 d-flex gap-2">
                                <a href="/manuales/ver/@m.Id" class="btn btn-outline-primary w-100">
                                    Leer Guía
                                </a>

                                <AuthorizeView Roles="Administrador,Asesor">
                                    <Authorized>
                                        <a href="/manuales/editar/@m.Id" class="btn btn-outline-secondary" title="Editar">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <button class="btn btn-outline-danger" title="Eliminar" @onclick="() => Eliminar(m.Id)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </Authorized>
                                </AuthorizeView>
                            </div>
                        </div>
                        <div class="card-footer bg-light text-muted small">
                            Actualizado: @(m.UltimaActualizacion?.ToShortDateString() ?? m.FechaCreacion.ToShortDateString())
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

<style>
    .hover-card { transition: transform 0.2s; }
    .hover-card:hover { transform: translateY(-5px); }
</style>

@code {
    private List<Manual>? manuales;
    private string busqueda = "";

    // Propiedad calculada para el filtro
    private IEnumerable<Manual> ManualesFiltrados =>
        string.IsNullOrWhiteSpace(busqueda)
        ? manuales ?? new List<Manual>()
        : manuales.Where(m => m.Titulo.Contains(busqueda, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        manuales = await ManualService.ObtenerTodosAsync();
    }

    private void CrearNuevo()
    {
        Nav.NavigateTo("/manuales/nuevo");
    }

    private async Task Eliminar(int id)
    {
        bool confirmado = await JS.InvokeAsync<bool>("confirm", "¿Estás seguro de eliminar este manual?");
        if (confirmado)
        {
            await ManualService.EliminarManualAsync(id);
            manuales = await ManualService.ObtenerTodosAsync(); // Recargar lista
        }
    }

    [Inject] IJSRuntime JS { get; set; }
}