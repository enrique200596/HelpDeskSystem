@page "/manuales"
@using HelpDeskSystem.Domain.Entities
@using HelpDeskSystem.Web.Services
@using Microsoft.AspNetCore.Authorization
@using System.Security.Claims
@using System.Timers
@inject IManualService ManualService
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JS
@implements IDisposable

<PageTitle>Base de Conocimiento | HelpDesk UTEPSA</PageTitle>

<div class="container-fluid px-4 py-4">

    @* --- ENCABEZADO Y ACCIÓN PRINCIPAL --- *@
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3 animate-enter">
        <div>
            <h6 class="text-uppercase text-secondary fw-bold mb-1" style="font-size: 0.7rem; letter-spacing: 1.2px; opacity: 0.8;">Recursos Técnicos</h6>
            <h2 class="fw-bold text-primary mb-0" style="letter-spacing: -0.5px;">Base de Conocimiento</h2>
        </div>

        <AuthorizeView Roles="Administrador,Asesor">
            <Authorized>
                <button class="btn btn-utepsa shadow-red-glow d-flex align-items-center gap-2 py-2 px-4" @onclick="CrearNuevo">
                    <i class="bi bi-plus-circle-fill fs-5"></i>
                    <span>Nuevo Manual</span>
                </button>
            </Authorized>
        </AuthorizeView>
    </div>

    @* --- BARRA DE BÚSQUEDA Y FILTROS --- *@
    <div class="card-pro mb-5 animate-enter shadow-sm border-0 bg-surface" style="animation-delay: 0.1s;">
        <div class="card-body p-3">
            <div class="row align-items-center">
                <div class="col-lg-6">
                    <div class="position-relative">
                        <span class="position-absolute top-50 start-0 translate-middle-y ms-3 text-secondary">
                            <i class="bi bi-search"></i>
                        </span>
                        @* CORRECCIÓN: Usamos @oninput con Debounce en lugar de bind directo para no saturar la DB *@
                        <input type="text" class="form-control-pro w-100 ps-5"
                               placeholder="Buscar por título de guía o palabras clave..."
                               value="@busqueda"
                               @oninput="OnBusquedaInput" />

                        @if (!string.IsNullOrEmpty(busqueda))
                        {
                            <button class="btn position-absolute end-0 top-50 translate-middle-y me-2 text-secondary border-0" @onclick="LimpiarBusqueda">
                                <i class="bi bi-x-circle-fill"></i>
                            </button>
                        }
                    </div>
                </div>
                <div class="col-lg-6 d-none d-lg-flex justify-content-end">
                    <span class="text-secondary small fw-medium">Explora guías paso a paso para resolver incidentes comunes.</span>
                </div>
            </div>
        </div>
    </div>

    @if (manuales == null)
    {
        <div class="row g-4">
            @for (int i = 0; i < 6; i++)
            {
                <div class="col-md-6 col-xl-4"><div class="card-pro p-5 placeholder-glow"><span class="placeholder col-12 rounded"></span></div></div>
            }
        </div>
    }
    else if (!manuales.Any())
    {
        <div class="text-center py-5 animate-enter">
            <i class="bi bi-journal-x fs-1 text-secondary opacity-25 d-block mb-3"></i>
            <h4 class="text-primary fw-bold">No se encontraron guías</h4>
            <p class="text-secondary small">Intenta con otros términos de búsqueda.</p>
        </div>
    }
    else
    {
        @* --- CUADRÍCULA DE MANUALES (Simetría Pro) --- *@
        <div class="row g-4 animate-enter" style="animation-delay: 0.2s;">
            @foreach (var m in manuales)
            {
                <div class="col-md-6 col-xl-4">
                    <div class="card-pro h-100 shadow-sm border-0 bg-surface d-flex flex-column card-manual-hover">

                        @* Estado de Borrador/Eliminado *@
                        @if (m.IsDeleted || !m.IsActive)
                        {
                            <div class="position-absolute top-0 end-0 m-3 z-2">
                                @if (m.IsDeleted)
                                {
                                    <span class="badge bg-danger rounded-pill shadow-sm">ELIMINADO</span>
                                }
                                else if (!m.IsActive)
                                {
                                    <span class="badge bg-warning text-dark rounded-pill shadow-sm">BORRADOR</span>
                                }
                            </div>
                        }

                        <div class="card-pro-body p-4 d-flex flex-column h-100">
                            <div class="d-flex align-items-start gap-3 mb-3">
                                <div class="bg-subtle rounded-3 p-3 d-flex align-items-center justify-content-center text-utepsa-red shadow-sm" style="width: 54px; height: 54px; flex-shrink: 0;">
                                    <i class="bi bi-file-earmark-richtext-fill fs-2"></i>
                                </div>
                                <div class="overflow-hidden">
                                    <h5 class="fw-bold text-primary mb-1 text-truncate" title="@m.Titulo">@m.Titulo</h5>
                                    <small class="text-secondary d-block">
                                        Por <span class="fw-bold text-dark">@(m.Autor?.Nombre ?? "Admin")</span>
                                        <i class="bi bi-dot"></i> @m.FechaCreacion.ToString("dd MMM yyyy")
                                    </small>
                                </div>
                            </div>

                            @* Etiquetas Interactivas *@
                            <div class="mb-4 flex-wrap d-flex gap-1">
                                @if (!string.IsNullOrEmpty(m.Etiquetas))
                                {
                                    @foreach (var tag in m.Etiquetas.Split(',', StringSplitOptions.RemoveEmptyEntries))
                                    {
                                        <span class="badge bg-light text-secondary border fw-normal px-2 py-1 transition-all hover-tag"
                                              @onclick="() => FiltrarPorEtiqueta(tag.Trim())" style="cursor: pointer; font-size: 0.7rem;">
                                            <i class="bi bi-tag-fill me-1 text-utepsa-red"></i>@tag.Trim()
                                        </span>
                                    }
                                }
                            </div>

                            @* Acciones de la Tarjeta *@
                            <div class="mt-auto pt-3 border-top border-light border-opacity-50">
                                <div class="d-flex gap-2">
                                    <a href="/manuales/ver/@m.Id" class="btn btn-dark flex-grow-1 fw-bold small py-2 rounded-3">
                                        LEER GUÍA COMPLETA
                                    </a>

                                    <AuthorizeView Roles="Administrador,Asesor">
                                        <Authorized>
                                            <div class="dropdown">
                                                <button class="btn btn-subtle border rounded-3 py-2 px-3" type="button" data-bs-toggle="dropdown">
                                                    <i class="bi bi-three-dots-vertical"></i>
                                                </button>
                                                <ul class="dropdown-menu dropdown-menu-end shadow-pro border-0">
                                                    <li><a class="dropdown-item py-2" href="/manuales/editar/@m.Id"><i class="bi bi-pencil me-2"></i> Editar</a></li>
                                                    <AuthorizeView Roles="Administrador" Context="adminContext">
                                                        <li><button class="dropdown-item py-2" @onclick="() => VerHistorial(m.Id, m.Titulo)"><i class="bi bi-clock-history me-2"></i> Historial</button></li>
                                                    </AuthorizeView>
                                                    <li><hr class="dropdown-divider"></li>
                                                    <li><button class="dropdown-item py-2 text-danger" @onclick="() => Eliminar(m.Id)"><i class="bi bi-trash me-2"></i> Eliminar</button></li>
                                                </ul>
                                            </div>
                                        </Authorized>
                                    </AuthorizeView>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }

    <HistorialManualModal @ref="modalHistorial" />
</div>

<style>
    .bg-surface {
        background-color: var(--bg-surface) !important;
    }

    .bg-subtle {
        background-color: var(--bg-subtle) !important;
    }

    .text-primary {
        color: var(--text-primary) !important;
    }

    .text-secondary {
        color: var(--text-secondary) !important;
    }

    .card-manual-hover {
        transition: all 0.3s ease;
        border: 1px solid transparent !important;
    }

        .card-manual-hover:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover) !important;
            border-color: var(--utepsa-red) !important;
        }

    .hover-tag:hover {
        background-color: var(--utepsa-red) !important;
        color: white !important;
    }

    .ls-1 {
        letter-spacing: 1px;
    }

    .btn-subtle {
        background-color: var(--bg-subtle);
        color: var(--text-primary);
    }

        .btn-subtle:hover {
            background-color: #e2e8f0;
        }
</style>

@code {
    private List<Manual>? manuales;
    private string busqueda = "";
    private HistorialManualModal modalHistorial = default!;
    private Timer? _debounceTimer;

    protected override async Task OnInitializedAsync()
    {
        await CargarManuales();
    }

    private async Task CargarManuales()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var rol = user.FindFirst(ClaimTypes.Role)?.Value;

        // CORRECCIÓN: Filtro en Servidor (SQL)
        manuales = await ManualService.ObtenerTodosAsync(rol, busqueda);

        // Refrescamos la UI explícitamente (útil para eventos de timer)
        await InvokeAsync(StateHasChanged);
    }

    private void CrearNuevo() => Nav.NavigateTo("/manuales/nuevo");

    private async Task VerHistorial(int manualId, string titulo) => await modalHistorial.Abrir(manualId, titulo);

    // CORRECCIÓN: Optimización de búsqueda "Live" (Debounce)
    private void OnBusquedaInput(ChangeEventArgs e)
    {
        busqueda = e.Value?.ToString() ?? "";

        // Reiniciamos el timer cada vez que el usuario escribe
        _debounceTimer?.Stop();
        _debounceTimer = new Timer(500); // Esperar 500ms
        _debounceTimer.AutoReset = false;
        _debounceTimer.Elapsed += async (sender, args) => await CargarManuales();
        _debounceTimer.Start();
    }

    private async Task FiltrarPorEtiqueta(string etiqueta)
    {
        busqueda = etiqueta;
        await CargarManuales();
    }

    private async Task LimpiarBusqueda()
    {
        busqueda = "";
        await CargarManuales();
    }

    private async Task Eliminar(int id)
    {
        bool confirmado = await JS.InvokeAsync<bool>("confirm", "¿Confirmas la eliminación definitiva de este recurso?");
        if (confirmado)
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            var claimId = user.FindFirst(ClaimTypes.NameIdentifier);

            if (claimId == null || !Guid.TryParse(claimId.Value, out Guid usuarioId))
            {
                await JS.InvokeVoidAsync("alert", "Error de seguridad: No se pudo identificar al usuario. Por favor recargue la sesión.");
                return;
            }

            try
            {
                await ManualService.EliminarManualAsync(id, usuarioId, user.IsInRole("Administrador"));
                await CargarManuales();
                await JS.InvokeVoidAsync("verificarYNotificar", "Manual eliminado correctamente", "success", false);
            }
            catch (Exception ex)
            {
                await JS.InvokeVoidAsync("verificarYNotificar", "No se pudo eliminar el manual.", "error", false);
            }
        }
    }

    public void Dispose()
    {
        _debounceTimer?.Dispose();
    }
}