@page "/manuales/ver/{Id:int}"
@using HelpDeskSystem.Domain.Entities
@using HelpDeskSystem.Web.Services
@using System.Globalization
@using System.Security.Claims
@inject IManualService ManualService
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JS

<PageTitle>@(manual?.Titulo ?? (noAutorizado ? "Acceso Restringido" : "Leyendo Manual")) | HelpDesk UTEPSA</PageTitle>

<div class="container py-4">

    @* --- NAVEGACIÓN Y ACCIONES --- *@
    <div class="d-flex justify-content-between align-items-center mb-4 no-print animate-enter">
        <button class="btn btn-link text-decoration-none p-0 text-secondary fw-bold hover-red d-flex align-items-center transition-all" @onclick="Volver">
            <i class="bi bi-arrow-left-circle-fill fs-5 me-2"></i> Volver a la Base de Conocimiento
        </button>

        @if (manual != null && !noAutorizado)
        {
            <div class="d-flex gap-2">
                <AuthorizeView Roles="Administrador,Asesor">
                    <a href="/manuales/editar/@manual.Id" class="btn btn-utepsa-ghost btn-sm rounded-pill px-3 fw-bold border-2">
                        <i class="bi bi-pencil-square me-2"></i> EDITAR
                    </a>
                </AuthorizeView>
                <button class="btn btn-outline-secondary btn-sm rounded-pill px-3 fw-bold border-2" @onclick='() => JS.InvokeVoidAsync("print")'>
                    <i class="bi bi-printer-fill me-2"></i> IMPRIMIR
                </button>
            </div>
        }
    </div>

    @if (cargando)
    {
        <div class="d-flex flex-column justify-content-center align-items-center py-5">
            <div class="spinner-grow text-utepsa-red mb-3"></div>
            <span class="text-secondary fw-bold ls-1">VALIDANDO CREDENCIALES Y CARGANDO...</span>
        </div>
    }
    else if (noAutorizado)
    {
        <div class="text-center py-5 animate-enter">
            <i class="bi bi-shield-lock-fill text-warning display-1 opacity-25"></i>
            <h2 class="fw-bold text-primary mt-3">Acceso Restringido</h2>
            <p class="text-secondary">No tienes los permisos necesarios para visualizar este recurso técnico.</p>
            <button class="btn btn-utepsa mt-3 px-4" @onclick="Volver">Regresar al listado</button>
        </div>
    }
    else if (manual == null)
    {
        <div class="text-center py-5 animate-enter">
            <i class="bi bi-exclamation-octagon-fill text-danger display-1 opacity-25"></i>
            <h2 class="fw-bold text-primary mt-3">Recurso no encontrado</h2>
            <p class="text-secondary">El manual solicitado no existe o ha sido eliminado permanentemente.</p>
            <button class="btn btn-utepsa mt-3 px-4" @onclick="Volver">Explorar otros manuales</button>
        </div>
    }
    else
    {
        <div class="row justify-content-center">
            <div class="col-lg-9 col-xl-8 animate-enter">
                <article class="card-pro shadow-pro border-0 bg-surface overflow-hidden">

                    @* HEADER DEL DOCUMENTO *@
                    <header class="card-pro-header p-4 p-md-5 bg-subtle border-bottom">
                        @if (!manual.IsActive)
                        {
                            <span class="badge bg-warning text-dark mb-3 px-3 py-2 rounded-pill shadow-sm">
                                <i class="bi bi-eye-slash-fill me-2"></i>ESTADO: BORRADOR (SÓLO PERSONAL AUTORIZADO)
                            </span>
                        }

                        <h1 class="display-5 fw-bold text-primary mb-4" style="letter-spacing: -1.5px; line-height: 1.1;">@manual.Titulo</h1>

                        <div class="d-flex flex-wrap align-items-center gap-4 text-secondary small fw-medium">
                            <div class="d-flex align-items-center">
                                <div class="bg-utepsa-red rounded-circle me-2 d-flex align-items-center justify-content-center text-white shadow-sm" style="width: 28px; height: 28px; font-size: 0.7rem;">
                                    @(manual.Autor?.Nombre?.Substring(0, 1).ToUpper() ?? "S")
                                </div>
                                <span>Autor: <strong class="text-primary">@(manual.Autor?.Nombre ?? "Soporte Técnico")</strong></span>
                            </div>

                            <div class="d-flex align-items-center">
                                <i class="bi bi-calendar3 text-utepsa-red me-2"></i>
                                <span>Publicado: @manual.FechaCreacion.ToString("D", CultureInfo.CurrentCulture)</span>
                            </div>

                            @if (manual.UltimaActualizacion.HasValue)
                            {
                                <div class="badge bg-white text-secondary border px-3 py-2 rounded-pill shadow-sm">
                                    <i class="bi bi-arrow-repeat me-1 text-success"></i> Act: @manual.UltimaActualizacion.Value.ToString("d")
                                </div>
                            }
                        </div>

                        @* VISUALIZACIÓN DE ETIQUETAS (MEJORA 100/100) *@
                        @if (manual.ManualEtiquetas != null && manual.ManualEtiquetas.Any())
                        {
                            <div class="mt-4 d-flex flex-wrap gap-2">
                                @foreach (var tag in manual.ManualEtiquetas)
                                {
                                    <span class="badge bg-light text-secondary border-0 px-3 py-2" style="font-size: 0.75rem;">
                                        <i class="bi bi-tag-fill me-1 text-utepsa-red"></i>@tag.Etiqueta
                                    </span>
                                }
                            </div>
                        }
                    </header>

                    @* CUERPO DEL MANUAL *@
                    <div class="card-pro-body p-4 p-md-5 manual-rich-text bg-surface">
                        @((MarkupString)manual.ContenidoHTML)
                    </div>

                    @* FOOTER DEL DOCUMENTO *@
                    <footer class="card-pro-footer p-4 bg-subtle border-top text-center no-print">
                        <p class="text-secondary small mb-0">
                            ¿Esta información no resolvió tu problema?
                            <a href="/nuevo-ticket" class="text-utepsa-red fw-bold text-decoration-none hover-underline ms-1">Contacta con Soporte</a>
                        </p>
                    </footer>
                </article>
            </div>
        </div>
    }
</div>

<style>
    .bg-surface {
        background-color: var(--bg-surface) !important;
    }

    .bg-subtle {
        background-color: var(--bg-subtle) !important;
    }

    .text-primary {
        color: var(--text-primary) !important;
    }

    .text-secondary {
        color: var(--text-secondary) !important;
    }

    .manual-rich-text {
        font-family: 'Inter', -apple-system, sans-serif;
        color: var(--text-primary);
        line-height: 1.8;
    }

        .manual-rich-text p {
            font-size: 1.1rem;
            margin-bottom: 1.5rem;
        }

        .manual-rich-text h2 {
            font-size: 1.75rem;
            font-weight: 800;
            border-left: 5px solid var(--utepsa-red);
            padding-left: 1rem;
            margin-top: 2.5rem;
        }

        .manual-rich-text img {
            max-width: 100%;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-pro);
            margin: 2rem 0;
        }

    @@media print {
        .no-print {
            display: none !important;
        }

        .card-pro {
            box-shadow: none !important;
            border: none !important;
        }
    }
</style>

@code {
    [Parameter] public int Id { get; set; }
    private Manual? manual;
    private bool cargando = true;
    private bool noAutorizado = false;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var userRol = user.FindFirst(ClaimTypes.Role)?.Value;

        // Recuperar manual (El servicio ignora filtros para permitir validación personalizada aquí)
        manual = await ManualService.ObtenerPorIdAsync(Id);

        if (manual != null)
        {
            // --- LÓGICA DE SEGURIDAD UI-SIDE (100/100) ---
            bool esAdmin = user.IsInRole("Administrador");

            // 1. Si está borrado, solo admin puede verlo
            if (manual.IsDeleted && !esAdmin)
            {
                manual = null;
            }
            // 2. Si no es admin, validar visibilidad por Rol y Estado Activo
            else if (!esAdmin)
            {
                bool tieneAccesoPorRol = !manual.RolesVisibles.Any() ||
                                         manual.RolesVisibles.Any(r => r.RolNombre == userRol);

                if (!manual.IsActive || !tieneAccesoPorRol)
                {
                    noAutorizado = true;
                }
            }
        }

        cargando = false;
    }

    private void Volver() => Nav.NavigateTo("/manuales");
}