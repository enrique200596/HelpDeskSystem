@page "/manuales/ver/{Id:int}"
@using HelpDeskSystem.Domain.Entities
@using HelpDeskSystem.Web.Services
@using System.Globalization
@inject IManualService ManualService
@inject NavigationManager Nav
@inject IJSRuntime JS

<PageTitle>@(manual?.Titulo ?? "Leyendo Manual") | HelpDesk UTEPSA</PageTitle>

<div class="container py-4">

    @* --- NAVEGACIÓN Y ACCIONES --- *@
    <div class="d-flex justify-content-between align-items-center mb-4 no-print animate-enter">
        <button class="btn btn-link text-decoration-none p-0 text-secondary fw-bold hover-red d-flex align-items-center transition-all" @onclick="Volver">
            <i class="bi bi-arrow-left-circle-fill fs-5 me-2"></i> Volver a la Base de Conocimiento
        </button>

        @if (manual != null)
        {
            <button class="btn btn-outline-secondary btn-sm rounded-pill px-3 fw-bold border-2" @onclick='() => JS.InvokeVoidAsync("print")'>
                <i class="bi bi-printer-fill me-2"></i> IMPRIMIR GUÍA
            </button>
        }
    </div>

    @if (manual == null)
    {
        @if (noEncontrado)
        {
            <div class="text-center py-5 animate-enter">
                <i class="bi bi-exclamation-octagon-fill text-danger display-1 opacity-25"></i>
                <h2 class="fw-bold text-primary mt-3">Recurso no disponible</h2>
                <p class="text-secondary">El manual solicitado no existe o ha sido retirado del sistema.</p>
                <button class="btn btn-utepsa mt-3 px-4" @onclick="Volver">Explorar otros manuales</button>
            </div>
        }
        else
        {
            <div class="d-flex flex-column justify-content-center align-items-center py-5">
                <div class="spinner-grow text-utepsa-red mb-3"></div>
                <span class="text-secondary fw-bold ls-1">CARGANDO DOCUMENTO...</span>
            </div>
        }
    }
    else
    {
        <div class="row justify-content-center">
            @* Limitamos el ancho a 9 para una lectura óptima (Max 800px-900px aprox) *@
            <div class="col-lg-9 col-xl-8 animate-enter">

                <article class="card-pro shadow-pro border-0 bg-surface overflow-hidden">

                    @* HEADER DEL DOCUMENTO *@
                    <header class="card-pro-header p-4 p-md-5 bg-subtle border-bottom">
                        <h1 class="display-5 fw-bold text-primary mb-4" style="letter-spacing: -1.5px; line-height: 1.1;">@manual.Titulo</h1>

                        <div class="d-flex flex-wrap align-items-center gap-4 text-secondary small fw-medium">
                            <div class="d-flex align-items-center">
                                <div class="bg-utepsa-red rounded-circle me-2 d-flex align-items-center justify-content-center text-white shadow-sm" style="width: 28px; height: 28px; font-size: 0.7rem;">
                                    @manual.Autor?.Nombre.Substring(0, 1).ToUpper()
                                </div>
                                <span>Autor: <strong class="text-primary">@(manual.Autor?.Nombre ?? "Soporte Técnico")</strong></span>
                            </div>

                            <div class="d-flex align-items-center">
                                <i class="bi bi-calendar3 text-utepsa-red me-2"></i>
                                <span>Publicado: @manual.FechaCreacion.ToString("D", CultureInfo.CurrentCulture)</span>
                            </div>

                            @if (manual.UltimaActualizacion.HasValue)
                            {
                                <div class="badge bg-white text-secondary border px-3 py-2 rounded-pill shadow-sm">
                                    <i class="bi bi-arrow-repeat me-1 text-success"></i> Actualizado: @manual.UltimaActualizacion.Value.ToString("d")
                                </div>
                            }
                        </div>
                    </header>

                    @* CUERPO DEL MANUAL *@
                    <div class="card-pro-body p-4 p-md-5 manual-rich-text bg-surface">
                        @((MarkupString)manual.ContenidoHTML)
                    </div>

                    @* FOOTER DEL DOCUMENTO *@
                    <footer class="card-pro-footer p-4 bg-subtle border-top text-center no-print">
                        <p class="text-secondary small mb-0">
                            ¿Esta información no resolvió tu problema?
                            <a href="/nuevo-ticket" class="text-utepsa-red fw-bold text-decoration-none hover-underline ms-1">Contacta con Soporte</a>
                        </p>
                    </footer>
                </article>

            </div>
        </div>
    }
</div>

<style>
    .bg-surface {
        background-color: var(--bg-surface) !important;
    }

    .bg-subtle {
        background-color: var(--bg-subtle) !important;
    }

    .text-primary {
        color: var(--text-primary) !important;
    }

    .text-secondary {
        color: var(--text-secondary) !important;
    }

    /* Estilos de Contenido (Rich Text) */
    .manual-rich-text {
        font-family: 'Inter', -apple-system, sans-serif;
        color: var(--text-primary);
        line-height: 1.8;
    }

        .manual-rich-text p {
            font-size: 1.1rem;
            margin-bottom: 1.5rem;
        }

        .manual-rich-text h2, .manual-rich-text h3 {
            color: var(--text-primary);
            font-weight: 800;
            margin-top: 2.5rem;
            margin-bottom: 1rem;
            letter-spacing: -0.5px;
        }

        .manual-rich-text h2 {
            font-size: 1.75rem;
            border-left: 5px solid var(--utepsa-red);
            padding-left: 1rem;
        }

        .manual-rich-text img {
            max-width: 100%;
            height: auto;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-pro);
            margin: 2rem 0;
            display: block;
        }

        .manual-rich-text ul, .manual-rich-text ol {
            margin-bottom: 1.5rem;
            padding-left: 1.5rem;
        }

        .manual-rich-text li {
            margin-bottom: 0.5rem;
        }

        .manual-rich-text blockquote {
            border-left: 4px solid var(--border-color);
            padding: 1rem 1.5rem;
            background-color: var(--bg-subtle);
            font-style: italic;
            border-radius: 0 var(--radius-md) var(--radius-md) 0;
            margin: 2rem 0;
        }

    @@media print {
        .no-print {
            display: none !important;
        }

        .card-pro {
            box-shadow: none !important;
            border: none !important;
        }

        .manual-rich-text {
            color: black !important;
        }

            .manual-rich-text h2 {
                color: #C8102E !important;
            }
    }
</style>

@code {
    [Parameter] public int Id { get; set; }
    private Manual? manual;
    private bool noEncontrado = false;

    protected override async Task OnInitializedAsync()
    {
        manual = await ManualService.ObtenerPorIdAsync(Id);
        if (manual == null) noEncontrado = true;
    }

    private void Volver() => Nav.NavigateTo("/manuales");
}