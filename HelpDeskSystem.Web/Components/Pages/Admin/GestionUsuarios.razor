@page "/admin/usuarios"
@attribute [Authorize(Roles = "Administrador")]
@using HelpDeskSystem.Domain.Entities
@using HelpDeskSystem.Domain.Enums
@using HelpDeskSystem.Web.Services
@using System.ComponentModel.DataAnnotations
@inject IUsuarioService ServicioUsuarios
@inject IJSRuntime JS

<PageTitle>Gestión de Usuarios | HelpDesk UTEPSA</PageTitle>

<div class="container-fluid px-4 py-4">

    @* --- CABECERA DE SECCIÓN --- *@
    <div class="mb-4 animate-enter">
        <h6 class="text-uppercase text-secondary fw-bold mb-1" style="font-size: 0.7rem; letter-spacing: 1.2px; opacity: 0.8;">Administración</h6>
        <h2 class="fw-bold text-primary mb-0" style="letter-spacing: -0.5px;">Control de Accesos y Personal</h2>
    </div>

    <div class="row g-4">
        @* === COLUMNA IZQUIERDA: FORMULARIO (Diseño Compacto y Alineado) === *@
        <div class="col-xl-4 col-lg-5 animate-enter" style="animation-delay: 0.1s;">
            <div class="card-pro shadow-sm border-0 sticky-top" style="top: 20px; z-index: 10;">
                <div class="card-pro-header border-bottom py-3 @(modoEdicion ? "bg-subtle border-warning" : "bg-subtle")">
                    <div class="d-flex align-items-center">
                        <div class="bg-surface rounded-circle d-flex align-items-center justify-content-center shadow-sm me-3" style="width: 38px; height: 38px;">
                            <i class="bi @(modoEdicion ? "bi-pencil-fill text-warning" : "bi-person-plus-fill text-utepsa-red") fs-5"></i>
                        </div>
                        <h6 class="mb-0 fw-bold text-primary">@(modoEdicion ? "Modificar Perfil" : "Nuevo Registro")</h6>
                    </div>
                </div>

                <div class="card-pro-body p-4">
                    <EditForm Model="modelo" OnValidSubmit="Guardar">
                        <DataAnnotationsValidator />

                        <div class="mb-3">
                            <label class="form-label text-secondary fw-bold small text-uppercase ls-1">Nombre Completo</label>
                            <InputText @bind-Value="modelo.Nombre" class="form-control-pro w-100" placeholder="Ej: Juan Perez" />
                            <ValidationMessage For="@(() => modelo.Nombre)" class="text-danger small mt-1 fw-bold" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label text-secondary fw-bold small text-uppercase ls-1">Correo Electrónico</label>
                            <InputText @bind-Value="modelo.Email" class="form-control-pro w-100" placeholder="juan@utepsa.edu" />
                            <ValidationMessage For="@(() => modelo.Email)" class="text-danger small mt-1 fw-bold" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label text-secondary fw-bold small text-uppercase ls-1">Rol en la Plataforma</label>
                            <div class="position-relative">
                                <InputSelect @bind-Value="modelo.Rol" class="form-control-pro w-100 appearance-none">
                                    <option value="@RolUsuario.Usuario">Usuario (Cliente)</option>
                                    <option value="@RolUsuario.Asesor">Asesor Técnico</option>
                                    <option value="@RolUsuario.Administrador">Administrador</option>
                                </InputSelect>
                                <i class="bi bi-chevron-down position-absolute end-0 top-50 translate-middle-y me-3 text-secondary pointer-events-none"></i>
                            </div>
                        </div>

                        <div class="mb-4 p-3 rounded-3 border bg-subtle">
                            <label class="form-label text-secondary fw-bold small text-uppercase ls-1 d-block mb-2">
                                @(modoEdicion ? "Seguridad (Opcional)" : "Seguridad (Requerida)")
                            </label>
                            <InputText @bind-Value="modelo.Password" type="password" class="form-control-pro w-100"
                                       placeholder="@(modoEdicion ? "•••• para cambiar" : "•••• (Min 4)")" />
                            <ValidationMessage For="@(() => modelo.Password)" class="text-danger small mt-1 fw-bold" />
                        </div>

                        @if (modoEdicion)
                        {
                            <div class="mb-4 form-check d-flex align-items-center gap-2">
                                <InputCheckbox @bind-Value="modelo.IsActive" class="form-check-input mt-0" id="checkActivo" style="width: 18px; height: 18px;" />
                                <label class="form-check-label fw-bold text-primary small" for="checkActivo">Habilitar acceso al sistema</label>
                            </div>
                        }

                        <div class="d-flex flex-column gap-2 mt-4">
                            <button type="submit" class="btn @(modoEdicion ? "btn-warning text-dark" : "btn-utepsa shadow-red-glow") py-2 fw-bold">
                                <i class="bi bi-cloud-arrow-up-fill me-2"></i> @(modoEdicion ? "GUARDAR CAMBIOS" : "REGISTRAR AHORA")
                            </button>

                            @if (modoEdicion)
                            {
                                <button type="button" class="btn btn-utepsa-ghost py-2 border text-secondary fw-bold" @onclick="CancelarEdicion">
                                    DESCARTAR
                                </button>
                            }
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>

        @* === COLUMNA DERECHA: TABLA DE DIRECTORIO (Simetría y Limpieza) === *@
        <div class="col-xl-8 col-lg-7 animate-enter" style="animation-delay: 0.2s;">
            <div class="card-pro shadow-sm border-0 bg-surface">
                <div class="card-pro-header border-bottom py-3">
                    <h6 class="mb-0 fw-bold text-primary">Directorio General de Personal</h6>
                </div>
                <div class="table-responsive custom-scrollbar">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-subtle">
                            <tr class="text-secondary small fw-bold text-uppercase">
                                <th class="ps-4 py-3 border-0" style="letter-spacing: 0.5px;">Integrante</th>
                                <th class="border-0">Rol</th>
                                <th class="border-0">Acceso</th>
                                <th class="text-end pe-4 border-0"></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var u in listaUsuarios)
                            {
                                <tr class="@(!u.IsActive ? "opacity-50" : "") border-bottom border-light">
                                    <td class="ps-4 py-3">
                                        <div class="d-flex align-items-center">
                                            <div class="rounded-circle bg-subtle text-primary d-flex align-items-center justify-content-center fw-bold me-3 shadow-sm border"
                                                 style="width: 36px; height: 36px; font-size: 0.85rem;">
                                                @u.Nombre.Substring(0, 1).ToUpper()
                                            </div>
                                            <div class="d-flex flex-column lh-sm">
                                                <span class="fw-bold text-primary" style="font-size: 0.9rem;">@u.Nombre</span>
                                                <small class="text-secondary">@u.Email</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        @switch (u.Rol)
                                        {
                                            case RolUsuario.Administrador:
                                                <span class="badge bg-danger bg-opacity-10 text-danger border border-danger px-2 py-1">ADMIN</span>
                                                break;
                                            case RolUsuario.Asesor:

                                                <span class="badge bg-warning bg-opacity-10 text-dark border border-warning px-2 py-1">ASESOR</span>
                                                break;
                                            default:

                                                <span class="badge bg-primary bg-opacity-10 text-primary border border-primary px-2 py-1">CLIENTE</span>
                                                break;
                                        }
                                    </td>
                                    <td>
                                        @if (u.IsActive)
                                        {
                                            <span class="text-success small fw-bold"><i class="bi bi-circle-fill me-1" style="font-size: 0.5rem;"></i> ACTIVO</span>
                                        }
                                        else
                                        {
                                            <span class="text-secondary small fw-bold"><i class="bi bi-circle-fill me-1" style="font-size: 0.5rem;"></i> BLOQUEADO</span>
                                        }
                                    </td>
                                    <td class="text-end pe-4">
                                        <button class="btn btn-sm btn-utepsa-ghost rounded-circle p-2" @onclick="() => Editar(u)" title="Editar Perfil">
                                            <i class="bi bi-pencil-square fs-5"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .ls-1 {
        letter-spacing: 1px;
    }

    .bg-surface {
        background-color: var(--bg-surface) !important;
    }

    .bg-subtle {
        background-color: var(--bg-subtle) !important;
    }

    .text-primary {
        color: var(--text-primary) !important;
    }

    .text-secondary {
        color: var(--text-secondary) !important;
    }

    .appearance-none {
        -webkit-appearance: none;
        appearance: none;
    }

    .pointer-events-none {
        pointer-events: none;
    }

    /* Sticky Form behavior */
    @@media (min-width: 992px) {
        .sticky-top {
            top: 2rem;
        }
    }
</style>

@code {
    private class UsuarioModel
    {
        public Guid Id { get; set; } = Guid.Empty;
        [Required(ErrorMessage = "Nombre requerido")] public string Nombre { get; set; } = "";
        [Required(ErrorMessage = "Email requerido")][EmailAddress] public string Email { get; set; } = "";
        public RolUsuario Rol { get; set; } = RolUsuario.Usuario;
        public string Password { get; set; } = "";
        public bool IsActive { get; set; } = true;
    }

    private List<Usuario> listaUsuarios = new();
    private UsuarioModel modelo = new();
    private bool modoEdicion = false;

    protected override async Task OnInitializedAsync() => await CargarUsuarios();

    private async Task CargarUsuarios() => listaUsuarios = await ServicioUsuarios.ObtenerTodosLosUsuariosAsync();

    private void Editar(Usuario u)
    {
        modelo = new UsuarioModel
        {
            Id = u.Id,
            Nombre = u.Nombre,
            Email = u.Email,
            Rol = u.Rol,
            IsActive = u.IsActive,
            Password = ""
        };
        modoEdicion = true;
    }

    private void CancelarEdicion()
    {
        modelo = new UsuarioModel();
        modoEdicion = false;
    }

    private async Task Guardar()
    {
        if (modoEdicion)
        {
            var usuarioEntidad = new Usuario
            {
                Id = modelo.Id,
                Nombre = modelo.Nombre,
                Email = modelo.Email,
                Rol = modelo.Rol,
                IsActive = modelo.IsActive
            };
            await ServicioUsuarios.ActualizarUsuarioAsync(usuarioEntidad);
            if (!string.IsNullOrWhiteSpace(modelo.Password))
            {
                await ServicioUsuarios.CambiarPasswordAsync(modelo.Id, modelo.Password);
            }
            await JS.InvokeVoidAsync("verificarYNotificar", "Usuario actualizado", "success", false);
        }
        else
        {
            if (string.IsNullOrWhiteSpace(modelo.Password))
            {
                await JS.InvokeVoidAsync("verificarYNotificar", "Contraseña requerida", "error", false);
                return;
            }
            var nuevo = new Usuario { Nombre = modelo.Nombre, Email = modelo.Email, Rol = modelo.Rol, IsActive = true };
            var resultado = await ServicioUsuarios.CrearUsuarioAsync(nuevo, modelo.Password);
            if (!resultado)
            {
                await JS.InvokeVoidAsync("verificarYNotificar", "El correo ya existe", "error", false);
                return;
            }
            await JS.InvokeVoidAsync("verificarYNotificar", "Usuario registrado", "success", false);
        }
        CancelarEdicion();
        await CargarUsuarios();
    }
}