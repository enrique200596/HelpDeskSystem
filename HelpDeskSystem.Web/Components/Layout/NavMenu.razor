@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using HelpDeskSystem.Web.Auth
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation

<div class="d-flex flex-column h-100 bg-utepsa-dark text-white shadow-pro">

    @* --- BRANDING --- *@
    <div class="d-flex align-items-center px-4 py-3 border-bottom border-secondary border-opacity-25" style="height: 64px;">
        <a class="navbar-brand d-flex align-items-center gap-2 text-white text-decoration-none" href="">
            <i class="bi bi-shield-check-fill text-utepsa-red fs-4"></i>
            <span class="fw-bold tracking-tight" style="font-size: 1.1rem;">HelpDesk <span class="fw-light opacity-75">UTEPSA</span></span>
        </a>
    </div>

    @* --- NAVEGACIÓN SCROLLABLE --- *@
    <div class="flex-grow-1 overflow-auto py-3 custom-scrollbar">
        <nav class="nav flex-column px-2 gap-1">
            <AuthorizeView>
                <Authorized>

                    <div class="nav-header px-3 mb-2 mt-2 text-uppercase fw-bold text-white-50" style="font-size: 0.7rem; letter-spacing: 1px;">Principal</div>

                    <NavLink class="nav-link d-flex align-items-center gap-3 px-3 py-2 rounded-3 text-white opacity-75 hover-effect" href="" Match="NavLinkMatch.All">
                        <i class="bi bi-kanban-fill"></i> <span>Tablero</span>
                    </NavLink>

                    <NavLink class="nav-link d-flex align-items-center gap-3 px-3 py-2 rounded-3 text-white opacity-75 hover-effect" href="dashboard">
                        <i class="bi bi-bar-chart-line-fill"></i> <span>Estadísticas</span>
                    </NavLink>

                    <NavLink class="nav-link d-flex align-items-center gap-3 px-3 py-2 rounded-3 text-white opacity-75 hover-effect" href="manuales">
                        <i class="bi bi-journal-richtext"></i> <span>Base de Conocimiento</span>
                    </NavLink>

                    <NavLink class="nav-link d-flex align-items-center gap-3 px-3 py-2 rounded-3 text-white opacity-75 hover-effect" href="ayuda">
                        <i class="bi bi-question-circle-fill"></i> <span>Ayuda</span>
                    </NavLink>

                    @if (EsRol("Usuario"))
                    {
                        <div class="mt-3 px-2">
                            <NavLink class="btn btn-utepsa w-100 d-flex align-items-center justify-content-center gap-2 shadow-sm" href="nuevo-ticket">
                                <i class="bi bi-plus-lg"></i> <span>Nuevo Ticket</span>
                            </NavLink>
                        </div>
                    }

                    @if (EsRol("Administrador"))
                    {
                        <div class="nav-header px-3 mb-2 mt-4 text-uppercase fw-bold text-white-50" style="font-size: 0.7rem; letter-spacing: 1px;">Administración</div>

                        <NavLink class="nav-link d-flex align-items-center gap-3 px-3 py-2 rounded-3 text-white opacity-75 hover-effect" href="reportes">
                            <i class="bi bi-file-earmark-bar-graph-fill"></i> <span>Reportes</span>
                        </NavLink>

                        <NavLink class="nav-link d-flex align-items-center gap-3 px-3 py-2 rounded-3 text-white opacity-75 hover-effect" href="admin/usuarios">
                            <i class="bi bi-people-fill"></i> <span>Usuarios</span>
                        </NavLink>

                        <NavLink class="nav-link d-flex align-items-center gap-3 px-3 py-2 rounded-3 text-white opacity-75 hover-effect" href="admin/categorias">
                            <i class="bi bi-tags-fill"></i> <span>Categorías</span>
                        </NavLink>

                        <NavLink class="nav-link d-flex align-items-center gap-3 px-3 py-2 rounded-3 text-white opacity-75 hover-effect" href="admin/asignar-especialidades">
                            <i class="bi bi-person-gear"></i> <span>Especialidades</span>
                        </NavLink>
                    }
                </Authorized>
            </AuthorizeView>
        </nav>
    </div>

    @* --- FOOTER: LOGOUT --- *@
    <div class="p-3 border-top border-secondary border-opacity-25 bg-black bg-opacity-25">
        <AuthorizeView>
            <Authorized>
                <form action="/account/logout" method="post">
                    <AntiforgeryToken />
                    <button type="submit" class="btn btn-outline-danger w-100 d-flex align-items-center justify-content-center gap-2 border-0 bg-danger bg-opacity-10 text-danger-emphasis">
                        <i class="bi bi-box-arrow-right"></i> <span>Cerrar Sesión</span>
                    </button>
                </form>
            </Authorized>
            <NotAuthorized>
                <NavLink class="btn btn-utepsa w-100" href="login">
                    <i class="bi bi-box-arrow-in-right me-2"></i> Iniciar Sesión
                </NavLink>
            </NotAuthorized>
        </AuthorizeView>
    </div>
</div>

<style>
    /* Estilos locales para hover effects */
    .hover-effect {
        transition: all 0.2s ease;
    }

        .hover-effect:hover, .nav-link.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: white !important;
            opacity: 1 !important;
            transform: translateX(5px);
        }

    .text-utepsa-red {
        color: var(--utepsa-red) !important;
    }

    .bg-utepsa-dark {
        background-color: var(--utepsa-dark) !important;
    }

    /* Scrollbar sutil */
    .custom-scrollbar::-webkit-scrollbar {
        width: 5px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 10px;
    }
</style>

@code {
    [CascadingParameter]
    private Task<AuthenticationState>? AuthState { get; set; }

    private ClaimsPrincipal? user;

    protected override async Task OnInitializedAsync()
    {
        // EL TRY-CATCH QUE FALTABA
        try
        {
            if (AuthState != null)
            {
                var state = await AuthState;
                user = state.User;
            }
        }
        catch
        {
            // Si falla al cargar el menú, asumimos usuario desconectado
            // en lugar de romper toda la página.
            user = null;
        }
    }

    private bool EsRol(string rolRequerido)
    {
        try
        {
            return user?.FindFirst(ClaimTypes.Role)?.Value == rolRequerido;
        }
        catch
        {
            return false;
        }
    }
}
}