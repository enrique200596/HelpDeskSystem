@inherits LayoutComponentBase
@using HelpDeskSystem.Web.Services
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject NavigationManager NavManager
@inject TicketStateContainer StateContainer
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JS
@implements IDisposable

<div class="page">
    <div class="sidebar">
        <NavMenu />
    </div>

    <main>
        <div class="top-row px-4 d-flex justify-content-between align-items-center bg-white shadow-sm" style="z-index: 10;">

            @* 1. Breadcrumbs Alineados *@
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0 bg-transparent p-0 d-flex align-items-center">
                    <li class="breadcrumb-item d-flex align-items-center">
                        @* ALINEACIÓN: d-inline-flex para centrar icono y texto *@
                        <a href="/" class="text-decoration-none text-muted small hover-red d-inline-flex align-items-center gap-1">
                            <i class="bi bi-house-door-fill mb-0"></i> Inicio
                        </a>
                    </li>
                    @if (!string.IsNullOrEmpty(nombrePagina) && nombrePagina != "Tablero Principal")
                    {
                        @* El separador "/" lo pone Bootstrap automáticamente, solo aseguramos la alineación del item *@
                        <li class="breadcrumb-item active text-danger fw-bold small d-flex align-items-center" aria-current="page">
                            <span class="mt-1">@nombrePagina</span> @* mt-1 es un ajuste fino óptico *@
                        </li>
                    }
                </ol>
            </nav>

            @* 2. Perfil de Usuario Alineado *@
            <AuthorizeView>
                <Authorized>
                    <div class="d-flex align-items-center gap-3 border-start ps-3 my-1">
                        <div class="text-end lh-1 d-none d-md-block">
                            <div class="fw-bold text-dark" style="font-size: 0.9rem;">
                                @context.User.Identity?.Name
                            </div>
                            <span class="badge bg-danger bg-opacity-10 text-danger mt-1 d-inline-flex align-items-center" style="font-size: 0.65rem; letter-spacing: 0.5px;">
                                @(context.User.FindFirst(ClaimTypes.Role)?.Value?.ToUpper() ?? "USUARIO")
                            </span>
                        </div>

                        @* Avatar Perfectamente Centrado *@
                        <div class="rounded-circle bg-dark text-white d-flex align-items-center justify-content-center shadow-sm flex-shrink-0"
                             style="width: 38px; height: 38px; font-weight: 600; font-size: 1.1rem; cursor: default;">
                            @* Ajuste óptico: a veces las letras mayúsculas se ven mejor subiéndolas 1px *@
                            <span style="margin-top: -1px;">@ObtenerIniciales(context.User.Identity?.Name)</span>
                        </div>
                    </div>
                </Authorized>
                <NotAuthorized>
                    <a href="login" class="btn btn-sm btn-outline-danger rounded-pill px-3 fw-bold">
                        <i class="bi bi-person-circle me-1"></i> Iniciar Sesión
                    </a>
                </NotAuthorized>
            </AuthorizeView>

        </div>

        <article class="content px-4 py-4">
            @Body
        </article>
    </main>
</div>

<div id="blazor-error-ui">
    Ha ocurrido un error inesperado.
    <a href="" class="reload">Recargar</a>
    <a class="dismiss">🗙</a>
</div>

@code {
    private string nombrePagina = "";

    // En MainLayout.razor

    private async void ManejarCambioGlobal(int? ticketId, string? tituloTicket, string? remitente, Guid? ownerId, Guid? asesorId)
    {
        await InvokeAsync(async () =>
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            if (user == null || user.Identity == null || !user.Identity.IsAuthenticated) return;

            // --- FILTRO DE PRIVACIDAD ---
            var myIdStr = user.FindFirst(ClaimTypes.Sid)?.Value ?? user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (Guid.TryParse(myIdStr, out Guid myId))
            {
                // 1. Si yo envié el mensaje, no me notifico.
                if (!string.IsNullOrEmpty(remitente) && remitente == user.Identity.Name) return;

                // 2. Si el ticket YA TIENE ASESOR (es un chat privado):
                // Solo notifico si soy el DUEÑO (ownerId) o el ASESOR ASIGNADO (asesorId).
                if (asesorId != null)
                {
                    if (myId != ownerId && myId != asesorId)
                    {
                        // Si soy Admin, quizás quiera ver todo, si no, retorno.
                        // Para cumplir tu regla estricta:
                        return;
                    }
                }
                // Si asesorId es null (Ticket Nuevo), dejamos pasar la notificación para que los asesores se enteren.
            }

            // --- VISUALIZACIÓN ---
            var urlActual = NavManager.Uri.ToLower();
            bool estaViendoElTicket = false;
            if (ticketId.HasValue && urlActual.Contains($"/ticket/{ticketId}"))
            {
                estaViendoElTicket = true;
            }

            string mensajeNotificacion = "Actividad en el sistema";
            if (!string.IsNullOrEmpty(tituloTicket) && !string.IsNullOrEmpty(remitente))
                mensajeNotificacion = $"{remitente}: {tituloTicket}";

            await JS.InvokeVoidAsync("verificarYNotificar", mensajeNotificacion, "info", estaViendoElTicket);
            StateHasChanged();
        });
    }

    protected override void OnInitialized()
    {
        NavManager.LocationChanged += AlCambiarUrl;
        ActualizarNombrePagina();
        StateContainer.OnChange += ManejarCambioGlobal;
    }
    // AGREGA ESTE MÉTODO:
    private async void NotificarCambioGlobal()
    {
        await InvokeAsync(async () =>
        {
            // "danger" activará el estilo rojo intenso
            await JS.InvokeVoidAsync("mostrarNotificacion", "¡Atención! Hay actividad reciente en el sistema.", "danger");
        });
    }

    private void AlCambiarUrl(object? sender, LocationChangedEventArgs e) { ActualizarNombrePagina(); StateHasChanged(); }
    private void ActualizarNombrePagina() { /* Tu lógica de nombres... */ }
    private string ObtenerIniciales(string? nombre) { return string.IsNullOrEmpty(nombre) ? "U" : nombre.Substring(0, 1).ToUpper(); }
    public void Dispose() { NavManager.LocationChanged -= AlCambiarUrl; StateContainer.OnChange -= ManejarCambioGlobal; }
}